<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ö–ò–ó —Å –∑–∞–¥–∞–Ω–∏—è–º–∏ WB</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .file-upload {
            margin-bottom: 20px;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .file-upload.has-file {
            border-color: #4CAF50;
            background: #f1f8f4;
        }

        .file-upload.has-warning {
            border-color: #ff9800;
            background: #fff8e1;
        }

        .file-upload.has-error {
            border-color: #f44336;
            background: #ffebee;
        }

        .file-upload label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
        }

        .file-upload input[type="file"] {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 5px;
            font-size: 13px;
            color: #2e7d32;
            display: none;
        }

        .file-upload.has-file .file-info,
        .file-upload.has-warning .file-info,
        .file-upload.has-error .file-info {
            display: block;
        }

        .file-upload.has-warning .file-info {
            background: #fff8e1;
            color: #f57c00;
        }

        .file-upload.has-error .file-info {
            background: #ffebee;
            color: #c62828;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .process-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .process-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .process-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .reset-btn {
            padding: 15px 25px;
            background: #78909c;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .reset-btn:hover {
            background: #546e7a;
            transform: translateY(-2px);
        }

        .check-btn {
            padding: 15px 25px;
            background: #00897b;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .check-btn:hover:not(:disabled) {
            background: #00695c;
            transform: translateY(-2px);
        }

        .check-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .results h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .mapping-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .mapping-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mapping-item:last-child {
            border-bottom: none;
        }

        .mapping-item .number {
            font-weight: 600;
            color: #667eea;
            min-width: 30px;
        }

        .mapping-item .details {
            flex: 1;
            margin-left: 15px;
        }

        .mapping-item .sticker {
            color: #666;
            font-size: 12px;
        }

        .mapping-item .kiz {
            color: #2e7d32;
            font-family: monospace;
            font-size: 11px;
            margin-top: 3px;
        }

        .download-btn {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .download-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(76, 175, 80, 0.4);
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #1565c0;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .stat-item.success {
            background: #e8f5e9;
        }

        .stat-item.warning {
            background: #fff8e1;
        }

        .stat-item.error {
            background: #ffebee;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-item.success .stat-value {
            color: #2e7d32;
        }

        .stat-item.warning .stat-value {
            color: #f57c00;
        }

        .stat-item.error .stat-value {
            color: #c62828;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .preview-section {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            display: none;
        }

        .preview-section.show {
            display: block;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .preview-section h4 {
            color: #333;
            font-size: 14px;
        }

        .preview-table-container {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border-radius: 5px;
        }

        .preview-table-container.expanded {
            max-height: 600px;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .preview-table th,
        .preview-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .preview-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .preview-table tr:last-child td {
            border-bottom: none;
        }

        .preview-table .more-rows {
            text-align: center;
            color: #999;
            font-style: italic;
        }

        .expand-btn {
            padding: 5px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .expand-btn:hover {
            background: #5567d5;
        }

        .warnings-section {
            margin-top: 15px;
            padding: 15px;
            background: #fff8e1;
            border-radius: 8px;
            border-left: 4px solid #ff9800;
        }

        .warnings-section h4 {
            color: #f57c00;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .warnings-list {
            font-size: 12px;
            color: #666;
            max-height: 150px;
            overflow-y: auto;
        }

        .warnings-list div {
            padding: 5px 0;
            border-bottom: 1px solid #ffe0b2;
        }

        .warnings-list div:last-child {
            border-bottom: none;
        }

        .duplicates-section {
            margin-top: 15px;
            padding: 15px;
            background: #ffebee;
            border-radius: 8px;
            border-left: 4px solid #f44336;
        }

        .duplicates-section h4 {
            color: #c62828;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: #bdbdbd;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .kiz-validation {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
        }

        .kiz-validation.valid {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .kiz-validation.warning {
            background: #fff8e1;
            color: #f57c00;
        }

        .kiz-validation.invalid {
            background: #ffebee;
            color: #c62828;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ö–ò–ó–æ–≤ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #00897b 0%, #00695c 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0 5px;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .check-results {
            margin-top: 15px;
        }

        .check-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .check-item:last-child {
            border-bottom: none;
        }

        .check-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .check-status.valid {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .check-status.invalid {
            background: #ffebee;
            color: #c62828;
        }

        .check-status.pending {
            background: #e3f2fd;
            color: #1976d2;
        }

        .check-status.error {
            background: #fff8e1;
            color: #f57c00;
        }

        .check-kiz {
            font-family: monospace;
            font-size: 11px;
            flex: 1;
            word-break: break-all;
        }

        .check-info {
            font-size: 11px;
            color: #666;
        }

        .api-notice {
            background: #fff8e1;
            border-left: 4px solid #ff9800;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #f57c00;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ö–ò–ó —Å –∑–∞–¥–∞–Ω–∏—è–º–∏ WB</h1>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ö–ò–ó–æ–≤</p>
        </div>

        <div class="content">
            <div class="info-box">
                <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong><br>
                1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –õ–∏—Å—Ç –ø–æ–¥–±–æ—Ä–∞ (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫)<br>
                2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –®–∞–±–ª–æ–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ (–∫—É–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ö–ò–ó—ã)<br>
                3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –ø—Ä–∏–µ–º–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV –∏–ª–∏ XLSX (–∏—Å—Ç–æ—á–Ω–∏–∫ –ö–ò–ó–æ–≤)<br>
                4. –ö–ò–ó—ã –±—É–¥—É—Ç —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –ø–æ –ø–æ—Ä—è–¥–∫—É —Å—Ç–∏–∫–µ—Ä–æ–≤ –∏–∑ –ª–∏—Å—Ç–∞ –ø–æ–¥–±–æ—Ä–∞
            </div>

            <div class="upload-section">
                <div class="file-upload" id="picking-upload">
                    <label>üìã –õ–∏—Å—Ç –ø–æ–¥–±–æ—Ä–∞ (WB-GI-*.xlsx)</label>
                    <input type="file" id="picking-file" accept=".xlsx,.xls">
                    <div class="file-info" id="picking-info"></div>
                </div>

                <div class="file-upload" id="template-upload">
                    <label>üìÑ –®–∞–±–ª–æ–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ (template-sgtin-*.xlsx)</label>
                    <input type="file" id="template-file" accept=".xlsx,.xls">
                    <div class="file-info" id="template-info"></div>
                </div>

                <div class="file-upload" id="csv-upload">
                    <label>üìä –§–∞–π–ª –ø—Ä–∏–µ–º–∫–∏ (.csv / .xlsx)</label>
                    <input type="file" id="csv-file" accept=".csv,.xlsx,.xls">
                    <div class="file-info" id="csv-info"></div>
                </div>
            </div>

            <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö -->
            <div class="preview-section" id="preview-section">
                <div class="preview-header">
                    <h4>üìã –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h4>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" data-tab="preview-picking">–õ–∏—Å—Ç –ø–æ–¥–±–æ—Ä–∞</button>
                    <button class="tab-btn" data-tab="preview-template">–®–∞–±–ª–æ–Ω</button>
                    <button class="tab-btn" data-tab="preview-kiz">–ö–ò–ó—ã</button>
                </div>

                <div class="tab-content active" id="preview-picking"></div>
                <div class="tab-content" id="preview-template"></div>
                <div class="tab-content" id="preview-kiz"></div>
            </div>

            <div class="btn-row">
                <button class="process-btn" id="process-btn" disabled>
                    –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª—ã
                </button>
                <button class="check-btn" id="check-btn" disabled title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ö–ò–ó—ã –≤ –ß–µ—Å—Ç–Ω–æ–º –ó–Ω–∞–∫–µ">
                    üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ö–ò–ó—ã
                </button>
                <button class="reset-btn" id="reset-btn">
                    üîÑ –°–±—Ä–æ—Å–∏—Ç—å
                </button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤...</p>
            </div>

            <div class="error" id="error"></div>

            <div class="results" id="results">
                <h3>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è</h3>

                <div class="stats" id="stats-container">
                    <div class="stat-item success">
                        <div class="stat-value" id="stat-success">0</div>
                        <div class="stat-label">–£—Å–ø–µ—à–Ω–æ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-total-tasks">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-total-kiz">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –ö–ò–ó–æ–≤</div>
                    </div>
                    <div class="stat-item warning" id="stat-skipped-container" style="display:none;">
                        <div class="stat-value" id="stat-skipped">0</div>
                        <div class="stat-label">–ü—Ä–æ–ø—É—â–µ–Ω–æ</div>
                    </div>
                    <div class="stat-item warning" id="stat-extra-container" style="display:none;">
                        <div class="stat-value" id="stat-extra">0</div>
                        <div class="stat-label">–õ–∏—à–Ω–∏—Ö –ö–ò–ó–æ–≤</div>
                    </div>
                    <div class="stat-item error" id="stat-duplicates-container" style="display:none;">
                        <div class="stat-value" id="stat-duplicates">0</div>
                        <div class="stat-label">–î—É–±–ª–∏–∫–∞—Ç–æ–≤</div>
                    </div>
                </div>

                <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Å—Ç–∏–∫–µ—Ä–∞—Ö -->
                <div class="warnings-section" id="warnings-section" style="display:none;">
                    <h4>‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Å—Ç–∏–∫–µ—Ä—ã (–Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —à–∞–±–ª–æ–Ω–µ)</h4>
                    <div class="warnings-list" id="warnings-list"></div>
                </div>

                <!-- –î—É–±–ª–∏–∫–∞—Ç—ã –ö–ò–ó–æ–≤ -->
                <div class="duplicates-section" id="duplicates-section" style="display:none;">
                    <h4>‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –ö–ò–ó–æ–≤</h4>
                    <div class="warnings-list" id="duplicates-list"></div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
                <div id="mass-check-section" style="margin-bottom: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <button id="check-all-results-btn" onclick="checkAllResultKiz()" style="padding: 10px 20px; background: #00897b; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                        üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –ö–ò–ó—ã
                    </button>
                    <span id="mass-check-progress" style="color: #1565c0; font-size: 13px;"></span>
                </div>

                <div class="mapping-list" id="mapping-list"></div>

                <button class="download-btn" id="download-btn">
                    ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ö–ò–ó–æ–≤ -->
    <div class="modal" id="check-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ö–ò–ó–æ–≤</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="api-notice" style="background: #e8f5e9; border-color: #4CAF50; color: #2e7d32;">
                    <strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ RE:MARK</strong><br>
                    –ó–∞–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ CORS-–ø—Ä–æ–∫—Å–∏.
                    –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ" –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.
                </div>

                <div class="check-results" id="check-results" style="max-height: 450px; overflow-y: auto;"></div>

                <div style="margin-top: 15px; padding: 10px; background: #fff8e1; border-radius: 5px; font-size: 11px; color: #f57c00;">
                    <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî CORS-–ø—Ä–æ–∫—Å–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω—ã.
                    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É üåê –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞ —Å–∞–π—Ç–µ RE:MARK.
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let pickingData = null;
        let templateData = null;
        let kizData = null;
        let resultWorkbook = null;

        // Parsed data for preview
        let parsedPicking = null;
        let parsedTemplate = null;
        let parsedKiz = null;

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        let previewExpanded = {
            picking: false,
            template: false,
            kiz: false
        };

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª–∞–¥–æ–∫
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
        document.getElementById('reset-btn').addEventListener('click', resetAll);

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.getElementById('check-btn').addEventListener('click', openCheckModal);
        document.getElementById('modal-close').addEventListener('click', closeCheckModal);
        document.getElementById('check-modal').addEventListener('click', (e) => {
            if (e.target.id === 'check-modal') closeCheckModal();
        });

        function openCheckModal() {
            document.getElementById('check-modal').classList.add('show');
            renderKizCheckList();
        }

        function closeCheckModal() {
            document.getElementById('check-modal').classList.remove('show');
        }

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
        let checkingInProgress = false;
        let checkResults = {};

        // CORS –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä–∞
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest='
        ];
        let currentProxyIndex = 0;

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏
        let kizCheckResults = {};

        // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –ö–ò–ó–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        function renderKizCheckList() {
            const resultsContainer = document.getElementById('check-results');
            const kizList = parsedKiz.uniqueKiz;
            kizCheckResults = {};

            resultsContainer.innerHTML = `
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button id="check-all-btn" onclick="checkAllKiz()"
                            style="padding: 8px 16px; background: #00897b; color: white; border: none; border-radius: 5px; font-size: 13px; cursor: pointer; font-weight: 600;">
                        üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ (${kizList.length})
                    </button>
                    <span id="check-progress-text" style="font-size: 12px; color: #666;"></span>
                </div>
                <div id="kiz-list">
                    ${kizList.map((kiz, i) => `
                        <div class="check-item-wrapper" id="kiz-wrapper-${i}">
                            <div class="check-item" id="kiz-item-${i}" style="display: flex; align-items: flex-start; gap: 8px; padding: 10px 0; border-bottom: 1px solid #eee;">
                                <div class="check-status pending" id="kiz-status-${i}" style="font-size: 11px; min-width: 28px; text-align: center; padding-top: 2px;">${i + 1}</div>
                                <div style="flex: 1; min-width: 0;">
                                    <div class="check-kiz" style="font-size: 11px; font-family: monospace; word-break: break-all;">${escapeHtml(kiz)}</div>
                                    <div class="check-info" id="kiz-info-${i}" style="font-size: 11px; color: #999; margin-top: 4px;">‚Äî</div>
                                    <div class="check-details" id="kiz-details-${i}" style="display: none; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; font-size: 11px;"></div>
                                </div>
                                <div style="display: flex; gap: 4px; flex-shrink: 0;">
                                    <button onclick="checkSingleKiz('${encodeURIComponent(kiz)}', ${i})"
                                            style="padding: 4px 10px; background: #00897b; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                                    </button>
                                    <button onclick="openKizCheck('${encodeURIComponent(kiz)}')"
                                            style="padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;" title="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ —Å–∞–π—Ç–µ">
                                        üåê
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –ö–ò–ó—ã
        async function checkAllKiz() {
            if (checkingInProgress) return;
            checkingInProgress = true;

            const btn = document.getElementById('check-all-btn');
            btn.disabled = true;
            btn.style.background = '#ccc';
            btn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';

            const kizList = parsedKiz.uniqueKiz;
            let checked = 0;
            let valid = 0;
            let invalid = 0;
            let errors = 0;

            for (let i = 0; i < kizList.length; i++) {
                const kiz = kizList[i];
                const result = await checkKizOnRemark(kiz);

                updateKizStatus(i, result);

                checked++;
                if (result.status === 'valid') valid++;
                else if (result.status === 'invalid') invalid++;
                else errors++;

                document.getElementById('check-progress-text').textContent =
                    `–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: ${checked}/${kizList.length} | ‚úì ${valid} | ‚úó ${invalid} | ? ${errors}`;

                // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–µ—Ä–≤–∏—Å
                if (i < kizList.length - 1) {
                    await new Promise(r => setTimeout(r, 800));
                }
            }

            btn.disabled = false;
            btn.style.background = '#00897b';
            btn.textContent = `üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ (${kizList.length})`;
            checkingInProgress = false;
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–¥–∏–Ω –ö–ò–ó
        async function checkSingleKiz(encodedKiz, index) {
            const kiz = decodeURIComponent(encodedKiz);
            updateKizStatus(index, { status: 'checking', info: '–ü—Ä–æ–≤–µ—Ä–∫–∞...' });

            const result = await checkKizOnRemark(kiz);
            updateKizStatus(index, result);
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ö–ò–ó–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        function updateKizStatus(index, result) {
            const statusEl = document.getElementById(`kiz-status-${index}`);
            const infoEl = document.getElementById(`kiz-info-${index}`);
            const detailsEl = document.getElementById(`kiz-details-${index}`);

            if (!statusEl || !infoEl) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            kizCheckResults[index] = result;

            if (result.status === 'checking') {
                statusEl.className = 'check-status pending';
                statusEl.textContent = '‚è≥';
                infoEl.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
                infoEl.style.color = '#999';
                if (detailsEl) detailsEl.style.display = 'none';
            } else if (result.status === 'valid') {
                statusEl.className = 'check-status valid';
                statusEl.textContent = '‚úì';
                infoEl.innerHTML = `<strong style="color: #2e7d32;">–í –æ–±–æ—Ä–æ—Ç–µ</strong>` +
                    (result.info && result.info !== '–í –æ–±–æ—Ä–æ—Ç–µ' ? ` ‚Äî ${escapeHtml(result.info)}` : '');
                infoEl.style.color = '#333';

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (detailsEl && result.details && Object.keys(result.details).length > 0) {
                    detailsEl.innerHTML = formatDetails(result.details);
                    detailsEl.style.display = 'block';
                }
            } else if (result.status === 'invalid') {
                statusEl.className = 'check-status invalid';
                statusEl.textContent = '‚úó';
                infoEl.innerHTML = `<strong style="color: #c62828;">${escapeHtml(result.info || '–ù–µ –Ω–∞–π–¥–µ–Ω')}</strong>`;
                infoEl.style.color = '#c62828';
                if (detailsEl) detailsEl.style.display = 'none';
            } else {
                statusEl.className = 'check-status error';
                statusEl.textContent = '?';
                infoEl.textContent = result.info || '–û—à–∏–±–∫–∞';
                infoEl.style.color = '#f57c00';
                if (detailsEl) detailsEl.style.display = 'none';
            }
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –ö–ò–ó–∞
        function formatDetails(details) {
            const rows = [];

            if (details.productName) {
                rows.push(`<div><strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong> ${escapeHtml(details.productName)}</div>`);
            }
            if (details.category) {
                rows.push(`<div><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${escapeHtml(details.category)}</div>`);
            }
            if (details.brand) {
                rows.push(`<div><strong>–ë—Ä–µ–Ω–¥:</strong> ${escapeHtml(details.brand)}</div>`);
            }
            if (details.producer) {
                // –°–æ–∫—Ä–∞—â–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
                let shortProducer = details.producer
                    .replace(/–û–ë–©–ï–°–¢–í–û –° –û–ì–†–ê–ù–ò–ß–ï–ù–ù–û–ô –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨–Æ/gi, '–û–û–û')
                    .replace(/–ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–ô –ü–†–ï–î–ü–†–ò–ù–ò–ú–ê–¢–ï–õ–¨/gi, '–ò–ü')
                    .replace(/–ê–ö–¶–ò–û–ù–ï–†–ù–û–ï –û–ë–©–ï–°–¢–í–û/gi, '–ê–û')
                    .replace(/–ü–£–ë–õ–ò–ß–ù–û–ï –ê–ö–¶–ò–û–ù–ï–†–ù–û–ï –û–ë–©–ï–°–¢–í–û/gi, '–ü–ê–û')
                    .replace(/["']/g, '');
                rows.push(`<div><strong>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:</strong> ${escapeHtml(shortProducer)}</div>`);
            }
            if (details.owner) {
                rows.push(`<div><strong>–í–ª–∞–¥–µ–ª–µ—Ü:</strong> ${escapeHtml(details.owner)}</div>`);
            }
            if (details.inn) {
                rows.push(`<div><strong>–ò–ù–ù:</strong> ${escapeHtml(details.inn)}</div>`);
            }
            if (details.gtin) {
                rows.push(`<div><strong>GTIN:</strong> ${escapeHtml(details.gtin)}</div>`);
            }
            if (details.expiry) {
                rows.push(`<div><strong>–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏:</strong> ${escapeHtml(details.expiry)}</div>`);
            }
            if (details.country) {
                rows.push(`<div><strong>–°—Ç—Ä–∞–Ω–∞:</strong> ${escapeHtml(details.country)}</div>`);
            }
            if (details.tnved) {
                rows.push(`<div><strong>–¢–ù –í–≠–î:</strong> ${escapeHtml(details.tnved)}</div>`);
            }
            if (details.status && details.status !== '–í –æ–±–æ—Ä–æ—Ç–µ') {
                rows.push(`<div><strong>–°—Ç–∞—Ç—É—Å:</strong> ${escapeHtml(details.status)}</div>`);
            }

            return rows.length > 0 ? rows.join('') : '<div style="color: #999;">–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</div>';
        }

        // –ó–∞–ø—Ä–æ—Å –∫ RE:MARK —á–µ—Ä–µ–∑ CORS –ø—Ä–æ–∫—Å–∏
        async function checkKizOnRemark(kiz) {
            const targetUrl = `https://remark-online.ru/check_cis/?code=${encodeURIComponent(kiz)}`;

            // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–∫—Å–∏
            for (let attempt = 0; attempt < CORS_PROXIES.length; attempt++) {
                const proxyIndex = (currentProxyIndex + attempt) % CORS_PROXIES.length;
                const proxyUrl = CORS_PROXIES[proxyIndex] + encodeURIComponent(targetUrl);

                try {
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'text/html' }
                    });

                    if (!response.ok) continue;

                    const html = await response.text();
                    const result = parseRemarkResponse(html);

                    // –ó–∞–ø–æ–º–Ω–∏–º —Ä–∞–±–æ—Ç–∞—é—â–∏–π –ø—Ä–æ–∫—Å–∏
                    currentProxyIndex = proxyIndex;
                    return result;

                } catch (error) {
                    console.log(`Proxy ${proxyIndex} failed:`, error.message);
                    continue;
                }
            }

            // –í—Å–µ –ø—Ä–æ–∫—Å–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏
            return { status: 'error', info: '–ü—Ä–æ–∫—Å–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã' };
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ –æ—Ç RE:MARK
        function parseRemarkResponse(html) {
            try {
                const details = {};

                // RE:MARK –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É —Å Bootstrap –∫–ª–∞—Å—Å–∞–º–∏
                // –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞: <th> —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø–æ–ª—è, <td> —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º –≤ <span class="fw-medium">

                // –§—É–Ω–∫—Ü–∏—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è HTML entities
                function decodeHtmlEntities(text) {
                    if (!text) return text;
                    return text
                        .replace(/&quot;/g, '"')
                        .replace(/&amp;/g, '&')
                        .replace(/&lt;/g, '<')
                        .replace(/&gt;/g, '>')
                        .replace(/&nbsp;/g, ' ')
                        .replace(/&#(\d+);/g, (m, n) => String.fromCharCode(n))
                        .trim();
                }

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã RE:MARK
                function extractField(fieldName) {
                    // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –ø–æ–ª–µ–º
                    const fieldPattern = new RegExp(
                        fieldName + '[\\s\\S]*?<\\/th>\\s*<td[^>]*>([\\s\\S]*?)<\\/td>',
                        'i'
                    );
                    const fieldMatch = html.match(fieldPattern);
                    if (!fieldMatch) return null;

                    const tdContent = fieldMatch[1];

                    // –ü–∞—Ç—Ç–µ—Ä–Ω 1: –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å title (text-truncate)
                    let match = tdContent.match(/title="([^"]+)"/i);
                    if (match) return decodeHtmlEntities(match[1]);

                    // –ü–∞—Ç—Ç–µ—Ä–Ω 2: –æ–±—ã—á–Ω—ã–π span —Å fw-medium
                    match = tdContent.match(/<span[^>]*class="[^"]*fw-medium[^"]*"[^>]*>([^<]+)<\/span>/i);
                    if (match) return decodeHtmlEntities(match[1]);

                    // –ü–∞—Ç—Ç–µ—Ä–Ω 3: –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –≤ span
                    match = tdContent.match(/<span[^>]*>([^<]+)<\/span>/i);
                    if (match) return decodeHtmlEntities(match[1].trim());

                    // –ü–∞—Ç—Ç–µ—Ä–Ω 4: —Ç–µ–∫—Å—Ç –Ω–∞–ø—Ä—è–º—É—é
                    const text = tdContent.replace(/<[^>]+>/g, '').trim();
                    return text || null;
                }

                // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ –ø–æ–ª—è
                details.category = extractField('–ö–∞—Ç–µ–≥–æ—Ä–∏—è');
                details.productName = extractField('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ');
                details.producer = extractField('–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å');
                details.gtin = extractField('GTIN');
                details.expiry = extractField('–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏');
                details.brand = extractField('–ë—Ä–µ–Ω–¥');
                details.tnved = extractField('–¢–ù–í–≠–î');
                details.country = extractField('–°—Ç—Ä–∞–Ω–∞');
                details.cryptoTail = extractField('–ö—Ä–∏–ø—Ç–æ—Ö–≤–æ—Å—Ç');

                // –í–ª–∞–¥–µ–ª–µ—Ü (–µ—Å–ª–∏ –µ—Å—Ç—å)
                details.owner = extractField('–í–ª–∞–¥–µ–ª–µ—Ü') || extractField('–¢–µ–∫—É—â–∏–π –≤–ª–∞–¥–µ–ª–µ—Ü') || extractField('–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫');

                // –ò–ù–ù –≤–ª–∞–¥–µ–ª—å—Ü–∞
                const innMatch = html.match(/–ò–ù–ù[:\s]*(\d{10,12})/i);
                if (innMatch) details.inn = innMatch[1];

                // –°—Ç–∞—Ç—É—Å - –∏—â–µ–º –≤ badge
                const statusMatch = html.match(/<span[^>]*class="[^"]*badge[^"]*"[^>]*>\s*(INTRODUCED|RETIRED|EMITTED|–í –æ–±–æ—Ä–æ—Ç–µ|–í—ã–±—ã–ª|–≠–º–∏—Ç–∏—Ä–æ–≤–∞–Ω)\s*<\/span>/i);
                if (statusMatch) {
                    const rawStatus = statusMatch[1].trim().toUpperCase();
                    if (rawStatus === 'INTRODUCED' || rawStatus === '–í –û–ë–û–†–û–¢–ï') {
                        details.status = '–í –æ–±–æ—Ä–æ—Ç–µ';
                    } else if (rawStatus === 'RETIRED' || rawStatus === '–í–´–ë–´–õ') {
                        details.status = '–í—ã–±—ã–ª';
                    } else if (rawStatus === 'EMITTED' || rawStatus === '–≠–ú–ò–¢–ò–†–û–í–ê–ù') {
                        details.status = '–≠–º–∏—Ç–∏—Ä–æ–≤–∞–Ω';
                    }
                } else if (html.includes('INTRODUCED')) {
                    details.status = '–í –æ–±–æ—Ä–æ—Ç–µ';
                } else if (html.includes('RETIRED')) {
                    details.status = '–í—ã–±—ã–ª';
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if (details.status === '–í –æ–±–æ—Ä–æ—Ç–µ') {
                    const infoParts = [];
                    if (details.productName) {
                        infoParts.push(details.productName);
                    }
                    if (details.producer) {
                        // –°–æ–∫—Ä–∞—â–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
                        let shortProducer = details.producer
                            .replace(/–û–ë–©–ï–°–¢–í–û –° –û–ì–†–ê–ù–ò–ß–ï–ù–ù–û–ô –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨–Æ/gi, '–û–û–û')
                            .replace(/–ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–ô –ü–†–ï–î–ü–†–ò–ù–ò–ú–ê–¢–ï–õ–¨/gi, '–ò–ü')
                            .replace(/–ê–ö–¶–ò–û–ù–ï–†–ù–û–ï –û–ë–©–ï–°–¢–í–û/gi, '–ê–û')
                            .replace(/–ü–£–ë–õ–ò–ß–ù–û–ï –ê–ö–¶–ò–û–ù–ï–†–ù–û–ï –û–ë–©–ï–°–¢–í–û/gi, '–ü–ê–û')
                            .replace(/["']/g, '');
                        infoParts.push('–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: ' + shortProducer);
                    }

                    return {
                        status: 'valid',
                        info: infoParts.length > 0 ? infoParts.join(' | ') : '–í –æ–±–æ—Ä–æ—Ç–µ',
                        details: details
                    };
                }

                if (details.status === '–í—ã–±—ã–ª') {
                    return {
                        status: 'invalid',
                        info: details.productName ? `–í—ã–±—ã–ª: ${details.productName}` : '–í—ã–±—ã–ª –∏–∑ –æ–±–æ—Ä–æ—Ç–∞',
                        details: details
                    };
                }

                if (details.status === '–≠–º–∏—Ç–∏—Ä–æ–≤–∞–Ω') {
                    return {
                        status: 'valid',
                        info: details.productName ? `–≠–º–∏—Ç–∏—Ä–æ–≤–∞–Ω: ${details.productName}` : '–≠–º–∏—Ç–∏—Ä–æ–≤–∞–Ω (–Ω–µ –≤–≤–µ–¥—ë–Ω)',
                        details: details
                    };
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫–∏
                if (html.includes('–ù–µ –Ω–∞–π–¥–µ–Ω') || html.includes('–Ω–µ –Ω–∞–π–¥–µ–Ω') || html.includes('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω')) {
                    return { status: 'invalid', info: '–ù–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ', details: {} };
                }

                if (html.includes('–û—à–∏–±–∫–∞') || html.includes('error') || html.includes('Error')) {
                    return { status: 'error', info: '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏', details: {} };
                }

                // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ö–æ—Ç—å –∫–∞–∫–∏–µ-—Ç–æ –¥–∞–Ω–Ω—ã–µ
                if (details.productName || details.producer || details.gtin) {
                    return {
                        status: 'valid',
                        info: details.productName || '–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã',
                        details: details
                    };
                }

                return { status: 'error', info: '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å', details: {} };

            } catch (error) {
                console.error('Parse error:', error);
                return { status: 'error', info: '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞', details: {} };
            }
        }

        // –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ö–ò–ó–∞ –Ω–∞ —Å–∞–π—Ç–µ RE:MARK
        function openKizCheck(encodedKiz) {
            window.open('https://remark-online.ru/check_cis/?code=' + encodedKiz, '_blank');
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ö–ò–ó–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyKiz(kiz, button) {
            navigator.clipboard.writeText(kiz).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úì';
                button.style.background = '#4CAF50';
                setTimeout(() => {
                    button.textContent = 'üìã';
                    button.style.background = '#667eea';
                }, 1500);
            }).catch(err => {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
            });
        }

        function resetAll() {
            pickingData = null;
            templateData = null;
            kizData = null;
            resultWorkbook = null;
            parsedPicking = null;
            parsedTemplate = null;
            parsedKiz = null;
            previewExpanded = { picking: false, template: false, kiz: false };

            // –°–±—Ä–æ—Å –∏–Ω–ø—É—Ç–æ–≤
            document.getElementById('picking-file').value = '';
            document.getElementById('template-file').value = '';
            document.getElementById('csv-file').value = '';

            // –°–±—Ä–æ—Å –∫–ª–∞—Å—Å–æ–≤
            ['picking-upload', 'template-upload', 'csv-upload'].forEach(id => {
                const el = document.getElementById(id);
                el.classList.remove('has-file', 'has-warning', 'has-error');
            });

            // –°–∫—Ä—ã—Ç–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            ['picking-info', 'template-info', 'csv-info'].forEach(id => {
                document.getElementById(id).textContent = '';
            });

            // –°–∫—Ä—ã—Ç–∏–µ —Å–µ–∫—Ü–∏–π
            document.getElementById('preview-section').classList.remove('show');
            document.getElementById('results').classList.remove('show');
            document.getElementById('error').classList.remove('show');

            // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
            document.getElementById('process-btn').disabled = true;
            document.getElementById('check-btn').disabled = true;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
        document.getElementById('picking-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    document.getElementById('picking-info').textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...';

                    pickingData = await readExcelFile(file);
                    parsedPicking = await parsePickingData(pickingData, file);

                    // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –∏–∑–≤–ª–µ—á–µ–Ω–æ
                    const photosCount = parsedPicking.filter(p => p.photoUrl).length;

                    const uploadEl = document.getElementById('picking-upload');
                    uploadEl.classList.remove('has-error', 'has-warning');
                    uploadEl.classList.add('has-file');
                    const photoInfo = photosCount > 0 ? `, üì∑ ${photosCount} —Ñ–æ—Ç–æ` : '';
                    document.getElementById('picking-info').textContent =
                        `‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${file.name} (${parsedPicking.length} –∑–∞–¥–∞–Ω–∏–π${photoInfo})`;

                    updatePreview();
                    checkAllFilesLoaded();
                } catch (error) {
                    showFileError('picking-upload', 'picking-info', error.message);
                }
            }
        });

        document.getElementById('template-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    templateData = await readExcelFile(file);
                    parsedTemplate = parseTemplateData(templateData);

                    const uploadEl = document.getElementById('template-upload');
                    uploadEl.classList.remove('has-error', 'has-warning');
                    uploadEl.classList.add('has-file');
                    document.getElementById('template-info').textContent =
                        `‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${file.name} (${parsedTemplate.length} —Å—Ç—Ä–æ–∫)`;

                    updatePreview();
                    checkAllFilesLoaded();
                } catch (error) {
                    showFileError('template-upload', 'template-info', error.message);
                }
            }
        });

        document.getElementById('csv-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const fileName = file.name.toLowerCase();
                    const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');

                    let rawData;
                    if (isExcel) {
                        rawData = await readKizFromExcel(file);
                    } else {
                        rawData = await readCSVFile(file);
                    }

                    // –ê–Ω–∞–ª–∏–∑ –ö–ò–ó–æ–≤ (–±–µ–∑ —Å—Ç—Ä–æ–≥–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
                    const analysis = analyzeKizData(rawData);
                    kizData = analysis.allKiz; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –ö–ò–ó—ã
                    parsedKiz = analysis;

                    const uploadEl = document.getElementById('csv-upload');
                    uploadEl.classList.remove('has-error', 'has-warning', 'has-file');

                    let statusClass = 'has-file';
                    let statusText = `‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${file.name} (${analysis.allKiz.length} –ö–ò–ó–æ–≤)`;

                    if (analysis.duplicates.length > 0) {
                        statusClass = 'has-warning';
                        statusText = `‚ö†Ô∏è ${file.name}: ${analysis.uniqueKiz.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ö–ò–ó–æ–≤, ${analysis.duplicates.length} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤`;
                        kizData = analysis.uniqueKiz; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ
                    }

                    uploadEl.classList.add(statusClass);
                    document.getElementById('csv-info').textContent = statusText;

                    updatePreview();
                    checkAllFilesLoaded();
                } catch (error) {
                    showFileError('csv-upload', 'csv-info', error.message);
                }
            }
        });

        function showFileError(uploadId, infoId, message) {
            const uploadEl = document.getElementById(uploadId);
            uploadEl.classList.remove('has-file', 'has-warning');
            uploadEl.classList.add('has-error');
            document.getElementById(infoId).textContent = '‚ùå –û—à–∏–±–∫–∞: ' + message;
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Å—Ç–∞ –ø–æ–¥–±–æ—Ä–∞ (—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏)
        async function parsePickingData(workbook, file) {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, raw: false});

            // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞
            const extractedImages = file ? await extractImagesFromExcel(file) : [];

            // –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
            let headerRowIndex = -1;
            let taskCol = -1, stickerCol = -1, photoCol = -1, nameCol = -1, articleCol = -1;

            for (let i = 0; i < Math.min(10, rows.length); i++) {
                const row = rows[i];
                if (!row) continue;

                for (let j = 0; j < row.length; j++) {
                    const cell = String(row[j] || '').toLowerCase().trim();
                    if (cell.includes('–Ω–æ–º–µ—Ä –∑–∞–¥–∞–Ω–∏—è') || cell.includes('–∑–∞–¥–∞–Ω–∏–µ') || cell === '‚Ññ') {
                        taskCol = j;
                    }
                    if (cell.includes('—Å—Ç–∏–∫–µ—Ä') || cell.includes('—à–∫ –∫–æ—Ä–æ–±–∞')) {
                        stickerCol = j;
                    }
                    if (cell.includes('—Ñ–æ—Ç–æ') || cell.includes('–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ') || cell.includes('–∫–∞—Ä—Ç–∏–Ω–∫')) {
                        photoCol = j;
                    }
                    if (cell.includes('–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ') || cell.includes('–Ω–∞–∑–≤–∞–Ω–∏–µ') || cell.includes('—Ç–æ–≤–∞—Ä')) {
                        nameCol = j;
                    }
                    if (cell.includes('–∞—Ä—Ç–∏–∫—É–ª') || cell.includes('article') || cell.includes('sku')) {
                        articleCol = j;
                    }
                }

                if (taskCol !== -1 || stickerCol !== -1) {
                    headerRowIndex = i;
                    break;
                }
            }

            // Fallback –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ (–ø–æ —Å–∫—Ä–∏–Ω—à–æ—Ç—É: –∑–∞–¥–∞–Ω–∏–µ=0, —Ñ–æ—Ç–æ=1, —Å—Ç–∏–∫–µ—Ä=2, –∞—Ä—Ç–∏–∫—É–ª=3)
            if (taskCol === -1) taskCol = 0;
            if (photoCol === -1) photoCol = 1;
            if (stickerCol === -1) stickerCol = 2;
            if (articleCol === -1) articleCol = 3;
            if (headerRowIndex === -1) headerRowIndex = 4;

            const result = [];
            for (let i = headerRowIndex + 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row) continue;

                const taskNumber = String(row[taskCol] || '').trim();
                const sticker = String(row[stickerCol] || '').trim();
                const productName = nameCol !== -1 ? String(row[nameCol] || '').trim() : '';
                const article = articleCol !== -1 ? String(row[articleCol] || '').trim() : '';

                // –ò—â–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ (–∏–∑ –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ JSZip)
                const rowImage = extractedImages.find(img => img.row === i);

                // –¢–∞–∫–∂–µ –∏—â–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —è—á–µ–π–∫–µ —Ñ–æ—Ç–æ (–µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–∞—è —Å—Å—ã–ª–∫–∞)
                let photoUrl = rowImage ? rowImage.dataUrl : null;
                if (!photoUrl && photoCol !== -1) {
                    const photoCell = String(row[photoCol] || '').trim();
                    if (photoCell && (photoCell.startsWith('http://') || photoCell.startsWith('https://'))) {
                        photoUrl = photoCell;
                    }
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫–∏ –≤ —è—á–µ–π–∫–µ
                if (!photoUrl && photoCol !== -1) {
                    const cellRef = XLSX.utils.encode_cell({r: i, c: photoCol});
                    const cell = sheet[cellRef];
                    if (cell && cell.l && cell.l.Target) {
                        photoUrl = cell.l.Target;
                    }
                }

                if (taskNumber && sticker) {
                    result.push({
                        taskNumber,
                        sticker,
                        normalizedSticker: normalizeSticker(sticker),
                        productName,
                        article,
                        photoUrl: photoUrl
                    });
                }
            }

            return result;
        }

        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ Excel —á–µ—Ä–µ–∑ JSZip
        async function extractImagesFromExcel(file) {
            const images = [];

            try {
                const zip = await JSZip.loadAsync(file);

                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ xl/media/
                const mediaFiles = {};
                for (const [path, zipEntry] of Object.entries(zip.files)) {
                    if (path.startsWith('xl/media/') && !zipEntry.dir) {
                        const blob = await zipEntry.async('blob');
                        const ext = path.split('.').pop().toLowerCase();
                        const mimeType = ext === 'png' ? 'image/png' :
                                        ext === 'jpg' || ext === 'jpeg' ? 'image/jpeg' :
                                        ext === 'gif' ? 'image/gif' : 'image/png';
                        mediaFiles[path] = URL.createObjectURL(new Blob([blob], {type: mimeType}));
                    }
                }

                // –ß–∏—Ç–∞–µ–º drawing rels –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
                const relsPath = 'xl/drawings/_rels/drawing1.xml.rels';
                const relsFile = zip.file(relsPath);
                const imageRels = {};

                if (relsFile) {
                    const relsXml = await relsFile.async('string');
                    const parser = new DOMParser();
                    const relsDoc = parser.parseFromString(relsXml, 'text/xml');
                    const relationships = relsDoc.getElementsByTagName('Relationship');

                    for (const rel of relationships) {
                        const id = rel.getAttribute('Id');
                        const target = rel.getAttribute('Target');
                        if (target && target.includes('media/')) {
                            const fullPath = 'xl/' + target.replace('../', '');
                            imageRels[id] = mediaFiles[fullPath];
                        }
                    }
                }

                // –ß–∏—Ç–∞–µ–º drawing1.xml –¥–ª—è –ø–æ–∑–∏—Ü–∏–π
                const drawingPath = 'xl/drawings/drawing1.xml';
                const drawingFile = zip.file(drawingPath);

                if (drawingFile) {
                    const drawingXml = await drawingFile.async('string');
                    const parser = new DOMParser();
                    const drawingDoc = parser.parseFromString(drawingXml, 'text/xml');

                    // –ò—â–µ–º –≤—Å–µ twoCellAnchor —ç–ª–µ–º–µ–Ω—Ç—ã (–ø–æ–∑–∏—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
                    const anchors = drawingDoc.getElementsByTagName('xdr:twoCellAnchor');

                    for (const anchor of anchors) {
                        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é "from" (–Ω–∞—á–∞–ª—å–Ω–∞—è —è—á–µ–π–∫–∞)
                        const fromEl = anchor.getElementsByTagName('xdr:from')[0];
                        if (!fromEl) continue;

                        const rowEl = fromEl.getElementsByTagName('xdr:row')[0];
                        const colEl = fromEl.getElementsByTagName('xdr:col')[0];
                        const row = rowEl ? parseInt(rowEl.textContent) : -1;
                        const col = colEl ? parseInt(colEl.textContent) : -1;

                        // –ü–æ–ª—É—á–∞–µ–º ID –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        const blipEl = anchor.getElementsByTagName('a:blip')[0];
                        if (!blipEl) continue;

                        const embedId = blipEl.getAttribute('r:embed');
                        if (embedId && imageRels[embedId]) {
                            images.push({
                                row: row,
                                col: col,
                                dataUrl: imageRels[embedId]
                            });
                        }
                    }
                }

                console.log(`Extracted ${images.length} images from Excel`);

            } catch (e) {
                console.log('Image extraction error:', e);
            }

            return images;
        }

        // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        function extractImagesFromSheet(workbook, sheet) {
            return []; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é async —Ñ—É–Ω–∫—Ü–∏—é
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–∞
        function parseTemplateData(workbook) {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, raw: false});

            // –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
            let headerRowIndex = 0;
            let taskCol = -1, stickerCol = -1, kizCol = -1;

            for (let i = 0; i < Math.min(5, rows.length); i++) {
                const row = rows[i];
                if (!row) continue;

                for (let j = 0; j < row.length; j++) {
                    const cell = String(row[j] || '').toLowerCase().trim();
                    if (cell.includes('–∑–∞–¥–∞–Ω–∏–µ') || cell.includes('–Ω–æ–º–µ—Ä')) {
                        taskCol = j;
                    }
                    if (cell.includes('—Å—Ç–∏–∫–µ—Ä') || cell.includes('—à–∫')) {
                        stickerCol = j;
                    }
                    if (cell.includes('–∫–∏–∑') || cell.includes('sgtin') || cell.includes('–∫–æ–¥')) {
                        kizCol = j;
                    }
                }

                if (taskCol !== -1 || stickerCol !== -1) {
                    headerRowIndex = i;
                    break;
                }
            }

            // Fallback
            if (taskCol === -1) taskCol = 0;
            if (stickerCol === -1) stickerCol = 1;
            if (kizCol === -1) kizCol = 2;

            const result = [];
            for (let i = headerRowIndex + 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row) continue;

                const taskNumber = String(row[taskCol] || '').trim();
                const sticker = String(row[stickerCol] || '').trim();

                if (taskNumber && sticker) {
                    result.push({
                        rowIndex: i,
                        taskNumber,
                        sticker,
                        normalizedSticker: normalizeSticker(sticker),
                        originalRow: row,
                        kizColIndex: kizCol
                    });
                }
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            result.headerRow = rows[headerRowIndex] || [];
            result.kizColIndex = kizCol;

            return result;
        }

        // –ê–Ω–∞–ª–∏–∑ –ö–ò–ó –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ —Å—Ç—Ä–æ–≥–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
        function analyzeKizData(rawData) {
            const allKiz = [];
            const uniqueKiz = [];
            const duplicates = [];
            const seen = new Set();

            for (const row of rawData) {
                const kiz = row['–ö–ò'];
                if (!kiz) continue;

                const trimmedKiz = String(kiz).trim();
                if (!trimmedKiz) continue;

                allKiz.push(trimmedKiz);

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
                if (seen.has(trimmedKiz)) {
                    duplicates.push(trimmedKiz);
                } else {
                    seen.add(trimmedKiz);
                    uniqueKiz.push(trimmedKiz);
                }
            }

            return { allKiz, uniqueKiz, duplicates };
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        function updatePreview() {
            const previewSection = document.getElementById('preview-section');

            if (parsedPicking || parsedTemplate || parsedKiz) {
                previewSection.classList.add('show');
            }

            // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ª–∏—Å—Ç–∞ –ø–æ–¥–±–æ—Ä–∞
            if (parsedPicking && parsedPicking.length > 0) {
                renderPreviewTable('preview-picking', 'picking', parsedPicking,
                    ['#', '–ó–∞–¥–∞–Ω–∏–µ', '–°—Ç–∏–∫–µ—Ä'],
                    (item, i) => [i + 1, item.taskNumber, item.sticker]
                );
            }

            // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —à–∞–±–ª–æ–Ω–∞
            if (parsedTemplate && parsedTemplate.length > 0) {
                renderPreviewTable('preview-template', 'template', parsedTemplate,
                    ['#', '–ó–∞–¥–∞–Ω–∏–µ', '–°—Ç–∏–∫–µ—Ä'],
                    (item, i) => [i + 1, item.taskNumber, item.sticker]
                );
            }

            // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ö–ò–ó–æ–≤
            if (parsedKiz) {
                renderKizPreview();
            }
        }

        function renderPreviewTable(containerId, key, data, headers, rowMapper) {
            const container = document.getElementById(containerId);
            const isExpanded = previewExpanded[key];
            const displayData = isExpanded ? data : data.slice(0, 10);
            const hasMore = data.length > 10;

            const html = `
                <div class="preview-table-container ${isExpanded ? 'expanded' : ''}">
                    <table class="preview-table">
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${displayData.map((item, i) => `
                                <tr>${rowMapper(item, i).map(cell => `<td>${escapeHtml(String(cell))}</td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ${hasMore ? `
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="expand-btn" onclick="toggleExpand('${key}')">
                            ${isExpanded ? '‚ñ≤ –°–≤–µ—Ä–Ω—É—Ç—å' : `‚ñº –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ (${data.length})`}
                        </button>
                    </div>
                ` : ''}
            `;

            container.innerHTML = html;
        }

        function renderKizPreview() {
            const container = document.getElementById('preview-kiz');
            const isExpanded = previewExpanded.kiz;
            const allKiz = parsedKiz.uniqueKiz;
            const displayKiz = isExpanded ? allKiz : allKiz.slice(0, 10);
            const hasMore = allKiz.length > 10;

            const html = `
                <div class="preview-table-container ${isExpanded ? 'expanded' : ''}">
                    <table class="preview-table">
                        <thead>
                            <tr><th>#</th><th>–ö–ò–ó</th><th>–î–ª–∏–Ω–∞</th></tr>
                        </thead>
                        <tbody>
                            ${displayKiz.map((kiz, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td style="font-family: monospace; font-size: 11px; word-break: break-all;">${escapeHtml(kiz)}</td>
                                    <td>${kiz.length}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ${parsedKiz.duplicates.length > 0 ? `
                    <div style="margin-top: 10px; padding: 10px; background: #fff8e1; border-radius: 5px; font-size: 12px; color: #f57c00;">
                        ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ ${parsedKiz.duplicates.length} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã)
                    </div>
                ` : ''}
                ${hasMore ? `
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="expand-btn" onclick="toggleExpand('kiz')">
                            ${isExpanded ? '‚ñ≤ –°–≤–µ—Ä–Ω—É—Ç—å' : `‚ñº –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ (${allKiz.length})`}
                        </button>
                    </div>
                ` : ''}
            `;

            container.innerHTML = html;
        }

        function toggleExpand(key) {
            previewExpanded[key] = !previewExpanded[key];
            updatePreview();
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
        function checkAllFilesLoaded() {
            const allLoaded = parsedPicking && parsedTemplate && parsedKiz;
            document.getElementById('process-btn').disabled = !allLoaded;
            document.getElementById('check-btn').disabled = !parsedKiz || parsedKiz.uniqueKiz.length === 0;
        }

        // –ß—Ç–µ–Ω–∏–µ Excel —Ñ–∞–π–ª–æ–≤
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array', raw: false});
                        resolve(workbook);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª'));
                reader.readAsArrayBuffer(file);
            });
        }

        // –ß—Ç–µ–Ω–∏–µ –ö–ò–ó–æ–≤ –∏–∑ Excel —Ñ–∞–π–ª–∞ –ø—Ä–∏–µ–º–∫–∏
        function readKizFromExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array', raw: false});
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, raw: false});

                        // –ò—â–µ–º –∫–æ–ª–æ–Ω–∫—É —Å –ö–ò–ó–∞–º–∏
                        let kizColumnIndex = -1;
                        const headerRow = rows[0] || [];

                        for (let i = 0; i < headerRow.length; i++) {
                            const header = String(headerRow[i] || '').trim().toUpperCase();
                            if (header === '–ö–ò' || header === '–ö–ò–ó' || header === 'SGTIN' || header === '–ö–û–î') {
                                kizColumnIndex = i;
                                break;
                            }
                        }

                        if (kizColumnIndex === -1) {
                            reject(new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ —Å –ö–ò–ó–∞–º–∏ (–ö–ò, –ö–ò–ó, SGTIN –∏–ª–∏ –ö–û–î)'));
                            return;
                        }

                        const result = [];
                        for (let i = 1; i < rows.length; i++) {
                            const kizValue = rows[i][kizColumnIndex];
                            if (kizValue && String(kizValue).trim()) {
                                result.push({'–ö–ò': String(kizValue).trim()});
                            }
                        }

                        resolve(result);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª'));
                reader.readAsArrayBuffer(file);
            });
        }

        // –ß—Ç–µ–Ω–∏–µ CSV —Å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫–∏
        function readCSVFile(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    encoding: 'UTF-8',
                    complete: (results) => {
                        if (results.data.length > 0 && results.data[0]['–ö–ò'] !== undefined) {
                            resolve(results.data);
                        } else {
                            Papa.parse(file, {
                                header: true,
                                encoding: 'windows-1251',
                                complete: (results2) => {
                                    if (results2.data.length > 0 && results2.data[0]['–ö–ò'] !== undefined) {
                                        resolve(results2.data);
                                    } else {
                                        const headers = Object.keys(results.data[0] || {});
                                        const kizHeader = headers.find(h =>
                                            h.toUpperCase().includes('–ö–ò') ||
                                            h.toUpperCase().includes('SGTIN') ||
                                            h.toUpperCase().includes('–ö–û–î')
                                        );

                                        if (kizHeader) {
                                            const normalized = results.data.map(row => ({
                                                '–ö–ò': row[kizHeader]
                                            }));
                                            resolve(normalized);
                                        } else {
                                            reject(new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ —Å –ö–ò–ó–∞–º–∏'));
                                        }
                                    }
                                },
                                error: (error) => reject(error)
                            });
                        }
                    },
                    error: (error) => reject(error)
                });
            });
        }

        // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∏–∫–µ—Ä–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        function normalizeSticker(sticker) {
            if (!sticker) return '';
            return String(sticker).replace(/\s+/g, '').trim();
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
        document.getElementById('process-btn').addEventListener('click', async () => {
            try {
                document.getElementById('loading').classList.add('show');
                document.getElementById('error').classList.remove('show');
                document.getElementById('results').classList.remove('show');

                // –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å —à–∞–±–ª–æ–Ω–∞ –ø–æ —Å—Ç–∏–∫–µ—Ä–∞–º
                const templateDict = {};
                for (const item of parsedTemplate) {
                    templateDict[item.normalizedSticker] = item;
                }

                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π workbook
                resultWorkbook = XLSX.utils.book_new();
                const headerRow = parsedTemplate.headerRow || ['–ù–æ–º–µ—Ä –∑–∞–¥–∞–Ω–∏—è', '–°—Ç–∏–∫–µ—Ä', '–ö–ò–ó'];
                const newSheet = XLSX.utils.aoa_to_sheet([headerRow]);

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                const mappings = [];
                const skippedStickers = [];
                let kizIndex = 0;

                for (let i = 0; i < parsedPicking.length; i++) {
                    const picking = parsedPicking[i];
                    const template = templateDict[picking.normalizedSticker];

                    if (!template) {
                        skippedStickers.push({
                            taskNumber: picking.taskNumber,
                            sticker: picking.sticker
                        });
                        continue;
                    }

                    if (kizIndex >= kizData.length) {
                        break;
                    }

                    const kiz = kizData[kizIndex];
                    const newRow = [...(template.originalRow || [])];

                    const kizColIndex = parsedTemplate.kizColIndex || 2;
                    newRow[kizColIndex] = kiz;

                    XLSX.utils.sheet_add_aoa(newSheet, [newRow], {origin: -1});

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç —è—á–µ–π–∫–∏ –∫–∞–∫ —Ç–µ–∫—Å—Ç
                    const rowNum = mappings.length + 2;
                    const cellRef = XLSX.utils.encode_cell({r: rowNum - 1, c: kizColIndex});
                    if (!newSheet[cellRef]) newSheet[cellRef] = {};
                    newSheet[cellRef].t = 's';
                    newSheet[cellRef].v = kiz;

                    mappings.push({
                        index: mappings.length + 1,
                        taskNumber: template.taskNumber,
                        sticker: picking.sticker,
                        kiz: kiz,
                        productName: picking.productName || '',
                        article: picking.article || '',
                        photoUrl: picking.photoUrl || null
                    });

                    kizIndex++;
                }

                XLSX.utils.book_append_sheet(resultWorkbook, newSheet, '–°–±–æ—Ä–æ—á–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è');

                displayResults({
                    mappings,
                    skippedStickers,
                    totalTasks: parsedPicking.length,
                    totalKiz: kizData.length,
                    extraKiz: kizData.length - kizIndex,
                    duplicates: parsedKiz.duplicates
                });

                document.getElementById('loading').classList.remove('show');
                document.getElementById('results').classList.add('show');

            } catch (error) {
                document.getElementById('loading').classList.remove('show');
                showError(error.message);
            }
        });

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function displayResults(data) {
            const { mappings, skippedStickers, totalTasks, totalKiz, extraKiz, duplicates } = data;

            document.getElementById('stat-success').textContent = mappings.length;
            document.getElementById('stat-total-tasks').textContent = totalTasks;
            document.getElementById('stat-total-kiz').textContent = totalKiz;

            // –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ
            if (skippedStickers.length > 0) {
                document.getElementById('stat-skipped-container').style.display = 'block';
                document.getElementById('stat-skipped').textContent = skippedStickers.length;

                document.getElementById('warnings-section').style.display = 'block';
                document.getElementById('warnings-list').innerHTML = skippedStickers.map(s =>
                    `<div>–ó–∞–¥–∞–Ω–∏–µ <strong>${escapeHtml(s.taskNumber)}</strong> ‚Äî —Å—Ç–∏–∫–µ—Ä ${escapeHtml(s.sticker)}</div>`
                ).join('');
            } else {
                document.getElementById('stat-skipped-container').style.display = 'none';
                document.getElementById('warnings-section').style.display = 'none';
            }

            // –õ–∏—à–Ω–∏–µ –ö–ò–ó—ã
            if (extraKiz > 0) {
                document.getElementById('stat-extra-container').style.display = 'block';
                document.getElementById('stat-extra').textContent = extraKiz;
            } else {
                document.getElementById('stat-extra-container').style.display = 'none';
            }

            // –î—É–±–ª–∏–∫–∞—Ç—ã
            if (duplicates.length > 0) {
                document.getElementById('stat-duplicates-container').style.display = 'block';
                document.getElementById('stat-duplicates').textContent = duplicates.length;

                document.getElementById('duplicates-section').style.display = 'block';
                document.getElementById('duplicates-list').innerHTML = [...new Set(duplicates)].slice(0, 10).map(d =>
                    `<div style="font-family: monospace; font-size: 11px;">${escapeHtml(d.substring(0, 50))}...</div>`
                ).join('') + (duplicates.length > 10 ? `<div>... –∏ –µ—â—ë ${duplicates.length - 10}</div>` : '');
            } else {
                document.getElementById('stat-duplicates-container').style.display = 'none';
                document.getElementById('duplicates-section').style.display = 'none';
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º mappings –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            window.resultMappings = mappings;
            window.resultKizStatuses = {};

            // –°–ø–∏—Å–æ–∫ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π
            const listHtml = mappings.map((m, idx) => {
                // –§–æ—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å URL
                const photoHtml = m.photoUrl
                    ? `<div class="photo-col" style="flex-shrink: 0;">
                        <img src="${m.photoUrl}" alt="–§–æ—Ç–æ" style="width: 70px; height: 70px; object-fit: contain; border-radius: 8px; background: #f5f5f5; border: 1px solid #e0e0e0;">
                       </div>`
                    : '';

                // –ê—Ä—Ç–∏–∫—É–ª –∫—Ä—É–ø–Ω–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ
                const articleBadge = m.article
                    ? `<span style="background: #667eea; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">${escapeHtml(m.article)}</span>`
                    : '';

                const productInfo = m.productName
                    ? `<div style="font-size: 13px; color: #333; margin-top: 5px; font-weight: 500;">${escapeHtml(m.productName)}</div>`
                    : '';

                return `
                <div class="mapping-item" id="result-item-${idx}" style="display: flex; gap: 15px; align-items: flex-start; padding: 15px; background: white; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <div class="number" style="min-width: 35px; font-size: 16px; font-weight: bold; color: #667eea;">${m.index}.</div>
                    ${photoHtml}
                    <div class="details" style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <span>–ó–∞–¥–∞–Ω–∏–µ: <strong style="font-size: 15px;">${escapeHtml(m.taskNumber)}</strong></span>
                            ${articleBadge}
                        </div>
                        ${productInfo}
                        <div class="sticker" style="margin-top: 6px; color: #666;">–°—Ç–∏–∫–µ—Ä: <span style="font-family: monospace;">${escapeHtml(m.sticker)}</span></div>
                        <div class="kiz" style="margin-top: 6px;">
                            –ö–ò–ó: <code style="font-size: 11px; background: #e8f5e9; padding: 3px 8px; border-radius: 4px; color: #2e7d32; word-break: break-all;">${escapeHtml(m.kiz)}</code>
                        </div>
                        <div id="result-kiz-status-${idx}" style="margin-top: 10px;"></div>
                    </div>
                    <div class="actions" style="flex-shrink: 0; display: flex; flex-direction: column; gap: 5px;">
                        <button onclick="checkResultKiz(${idx})" id="check-result-btn-${idx}" style="padding: 10px 15px; background: #00897b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s;">
                            üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                        </button>
                        <button onclick="openKizCheck('${encodeURIComponent(m.kiz)}')" style="padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; transition: all 0.2s;">
                            üåê RE:MARK
                        </button>
                    </div>
                </div>
            `}).join('');

            document.getElementById('mapping-list').innerHTML = listHtml || '<div style="padding: 20px; text-align: center; color: #999;">–ù–µ—Ç —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π</div>';
        }

        // –ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ö–ò–ó–æ–≤ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
        async function checkAllResultKiz() {
            if (!window.resultMappings || window.resultMappings.length === 0) return;

            const btn = document.getElementById('check-all-results-btn');
            const progressSpan = document.getElementById('mass-check-progress');

            btn.disabled = true;
            btn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';

            let checked = 0;
            let valid = 0;
            let invalid = 0;
            let errors = 0;
            const total = window.resultMappings.length;

            for (let i = 0; i < total; i++) {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ
                if (window.resultKizStatuses[i]) {
                    checked++;
                    if (window.resultKizStatuses[i].status === 'valid') valid++;
                    else if (window.resultKizStatuses[i].status === 'invalid') invalid++;
                    else errors++;
                    continue;
                }

                await checkResultKiz(i);
                checked++;

                const result = window.resultKizStatuses[i];
                if (result) {
                    if (result.status === 'valid') valid++;
                    else if (result.status === 'invalid') invalid++;
                    else errors++;
                }

                progressSpan.textContent = `–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: ${checked}/${total} | ‚úì ${valid} | ‚úó ${invalid} | ? ${errors}`;

                // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                if (i < total - 1) {
                    await new Promise(r => setTimeout(r, 800));
                }
            }

            btn.disabled = false;
            btn.textContent = '‚úì –í—Å–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ';
            btn.style.background = '#4CAF50';
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ö–ò–ó–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
        async function checkResultKiz(idx) {
            const mapping = window.resultMappings[idx];
            if (!mapping) return;

            const btn = document.getElementById(`check-result-btn-${idx}`);
            const statusDiv = document.getElementById(`result-kiz-status-${idx}`);

            btn.disabled = true;
            btn.textContent = '‚è≥...';
            statusDiv.innerHTML = '<span style="color: #666; font-size: 12px;">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>';

            try {
                const result = await checkKizOnRemark(mapping.kiz);
                window.resultKizStatuses[idx] = result;

                let statusHtml = '';
                if (result.status === 'valid') {
                    statusHtml = `<div style="background: #e8f5e9; padding: 10px; border-radius: 5px; font-size: 12px;">
                        <div style="color: #2e7d32; font-weight: bold;">‚úì ${escapeHtml(result.info)}</div>`;

                    if (result.details) {
                        const d = result.details;
                        // –°—Ç–∞—Ç—É—Å –ö–ò–ó–∞ —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π
                        if (d.status) {
                            const statusColor = d.status === '–í –æ–±–æ—Ä–æ—Ç–µ' ? '#2e7d32' :
                                               d.status === '–í—ã–±—ã–ª' ? '#c62828' : '#f57c00';
                            const statusBg = d.status === '–í –æ–±–æ—Ä–æ—Ç–µ' ? '#c8e6c9' :
                                            d.status === '–í—ã–±—ã–ª' ? '#ffcdd2' : '#ffe0b2';
                            statusHtml += `<div style="margin-top: 5px; margin-bottom: 8px;">
                                <span style="background: ${statusBg}; color: ${statusColor}; padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 11px;">
                                    –°—Ç–∞—Ç—É—Å: ${escapeHtml(d.status)}
                                </span>
                            </div>`;
                        }
                        if (d.productName) statusHtml += `<div style="margin-top: 5px;"><strong>–¢–æ–≤–∞—Ä:</strong> ${escapeHtml(d.productName)}</div>`;
                        if (d.producer) statusHtml += `<div><strong>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:</strong> ${escapeHtml(d.producer)}</div>`;
                        if (d.gtin) statusHtml += `<div><strong>GTIN:</strong> ${escapeHtml(d.gtin)}</div>`;
                        if (d.expiry) statusHtml += `<div><strong>–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏:</strong> ${escapeHtml(d.expiry)}</div>`;
                        if (d.owner) statusHtml += `<div><strong>–í–ª–∞–¥–µ–ª–µ—Ü:</strong> ${escapeHtml(d.owner)}</div>`;
                        if (d.brand) statusHtml += `<div><strong>–ë—Ä–µ–Ω–¥:</strong> ${escapeHtml(d.brand)}</div>`;
                    }
                    statusHtml += '</div>';
                } else if (result.status === 'invalid') {
                    statusHtml = `<div style="background: #ffebee; padding: 10px; border-radius: 5px; font-size: 12px; color: #c62828;">
                        ‚úó ${escapeHtml(result.info)}
                    </div>`;
                } else {
                    statusHtml = `<div style="background: #fff8e1; padding: 10px; border-radius: 5px; font-size: 12px; color: #f57c00;">
                        ‚ö†Ô∏è ${escapeHtml(result.info)}
                    </div>`;
                }

                statusDiv.innerHTML = statusHtml;
                btn.textContent = '‚úì –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ';
                btn.style.background = '#4CAF50';

            } catch (error) {
                statusDiv.innerHTML = `<span style="color: #f44336; font-size: 12px;">–û—à–∏–±–∫–∞: ${escapeHtml(error.message)}</span>`;
                btn.textContent = 'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
                btn.disabled = false;
            }
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        document.getElementById('download-btn').addEventListener('click', () => {
            if (resultWorkbook) {
                const timestamp = new Date().toISOString().slice(0,10);
                const filename = `template-sgtin-filled-${timestamp}.xlsx`;
                XLSX.writeFile(resultWorkbook, filename);
            }
        });

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.classList.add('show');
        }
    </script>
</body>
</html>

# Настройка Google Sheets

## Шаг 1: Создание Google Cloud проекта

1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
2. Создайте новый проект или выберите существующий
3. Включите Google Sheets API:
   - Перейдите в "APIs & Services" → "Library"
   - Найдите "Google Sheets API"
   - Нажмите "Enable"

## Шаг 2: Создание сервисного аккаунта

1. Перейдите в "IAM & Admin" → "Service Accounts"
2. Нажмите "Create Service Account"
3. Заполните:
   - Name: `finance-system-bot`
   - Description: `Service account for Finance Management System`
4. Нажмите "Create and Continue"
5. Пропустите роли (Grant this service account access to project) - нажмите "Continue"
6. Нажмите "Done"

## Шаг 3: Создание ключа

1. Найдите созданный сервисный аккаунт в списке
2. Нажмите на него
3. Перейдите на вкладку "Keys"
4. Нажмите "Add Key" → "Create new key"
5. Выберите формат "JSON"
6. Нажмите "Create" - файл скачается

## Шаг 4: Извлечение данных из JSON

Откройте скачанный JSON файл. Вам нужны два поля:

```json
{
  "private_key": "[PRIVATE_KEY_PLACEHOLDER]
  "client_email": "finance-system-bot@your-project.iam.gserviceaccount.com"
}
```

Скопируйте:
- `client_email` → в `.env` как `GOOGLE_SERVICE_ACCOUNT_EMAIL`
- `private_key` → в `.env` как `GOOGLE_PRIVATE_KEY` (целиком, с кавычками)

## Шаг 5: Создание таблиц

### 5.1 Главная таблица "Финансы - Контроль"

1. Создайте новую Google Таблицу
2. Назовите: "Финансы - Контроль"
3. Скопируйте ID таблицы из URL:
   ```
   https://docs.google.com/spreadsheets/d/YOUR_SPREADSHEET_ID/edit
   ```
4. Вставьте ID в `.env` как `MAIN_SPREADSHEET_ID`

#### Лист "Заявки"

Создайте первый лист с названием "Заявки" и добавьте заголовки в первую строку:

| A | B | C | D | E | F | G | H | I | J | K | L | M | N | O | P | Q | R | S | T |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| ID | Дата создания | Автор | Компания | Категория | Получатель | Сумма RUB | Способ оплаты | Реквизиты | Назначение платежа | Кошелек списания | Статус | Срочность | Одобрил | Дата одобрения | Оплатил | Дата оплаты | Курс USDT/RUB | Сумма USDT | Комментарии |

**Формула для колонки S (Сумма USDT):**
```
=IF(AND(NOT(ISBLANK(G2)), NOT(ISBLANK(R2))), G2/R2, "")
```
Протяните формулу вниз для всех строк.

**Валидация данных:**

- Колонка D (Компания): Данные → Проверка данных → Список: `ООО Альфа, ООО Бета, ИП Иванов`
- Колонка E (Категория): Список: `Зарплата, Поставщик, Маркетинг, Логистика, Офис, Прочее`
- Колонка H (Способ оплаты): Список: `Карта, СБП, Телефон, Наличные, Крипта, BYN`
- Колонка L (Статус): Список: `Создана, Одобрена, В работе, Оплачена, Отклонена`
- Колонка M (Срочность): Список: `Обычная, Срочная`

**Условное форматирование:**

1. Выделите колонку L (Статус)
2. Формат → Условное форматирование
3. Добавьте правила:
   - "Создана" → желтый фон
   - "Одобрена" → голубой фон
   - "Оплачена" → зеленый фон
   - "Отклонена" → красный фон

#### Лист "Балансы кошельков"

Создайте второй лист "Балансы кошельков":

| A | B | C | D | E | F | G |
|---|---|---|---|---|---|---|
| Компания | Название кошелька | Тип | Баланс USDT | Последнее обновление | Ответственный | Примечание |

Добавьте несколько примеров кошельков:

| Компания | Название кошелька | Тип | Баланс USDT | Последнее обновление | Ответственный | Примечание |
|---|---|---|---|---|---|---|
| ООО Альфа | XRocket основной | XRocket | 1250.00 | | @executor | Для зарплат |
| ООО Альфа | Холодный #1 | Холодный | 5600.00 | | @executor | Крупные платежи |
| ООО Бета | XRocket #2 | XRocket | 340.00 | | @executor | Мелкие расходы |

**Валидация:**
- Колонка C (Тип): Список: `Холодный, XRocket, Другой`

#### Лист "Сводка по компаниям"

Создайте третий лист "Сводка по компаниям":

| A | B |
|---|---|
| Компания | Общий баланс USDT |
| ООО Альфа | =SUMIF('Балансы кошельков'!A:A, A2, 'Балансы кошельков'!D:D) |
| ООО Бета | =SUMIF('Балансы кошельков'!A:A, A3, 'Балансы кошельков'!D:D) |

Добавьте раздел "Расходы за месяц":

| A | B |
|---|---|
| | |
| Категория | Сумма за текущий месяц |
| Зарплата | =SUMIFS(Заявки!G:G, Заявки!E:E, "Зарплата", Заявки!L:L, "Оплачена") |
| Маркетинг | =SUMIFS(Заявки!G:G, Заявки!E:E, "Маркетинг", Заявки!L:L, "Оплачена") |
| Логистика | =SUMIFS(Заявки!G:G, Заявки!E:E, "Логистика", Заявки!L:L, "Оплачена") |

#### Лист "Курсы валют"

Создайте четвертый лист "Курсы валют":

| A | B | C |
|---|---|---|
| Дата | USDT/RUB | RUB/BYN |
| | 73.50 | 0.029 |

### 5.2 Таблица "Зарплаты - Реестр"

1. Создайте новую Google Таблицу
2. Назовите: "Зарплаты - Реестр"
3. Скопируйте ID таблицы
4. Вставьте в `.env` как `PAYROLL_SPREADSHEET_ID`

#### Лист "Начисления сотрудников"

| A | B | C | D | E | F | G | H | I | J | K |
|---|---|---|---|---|---|---|---|---|---|---|
| ФИО | Должность | Период | Оклад | Бонусы | KPI | Надбавки | Вычеты | ИТОГО к выплате | Способ оплаты | Реквизиты |

**Формула для колонки I (ИТОГО):**
```
=SUM(D2:G2)-H2
```

#### Лист "Заявки на ЗП"

| A | B |
|---|---|
| Общая сумма ЗП | =SUM('Начисления сотрудников'!I:I) |

## Шаг 6: Настройка доступов

1. Откройте обе созданные таблицы
2. Нажмите "Настроить доступ" (Share)
3. Добавьте сервисный аккаунт (email из JSON) с правами "Редактор"
4. Добавьте свой email с правами "Владелец"

## Шаг 7: Защита данных

### Защита колонок в листе "Заявки":

1. Выделите колонки A, B, C (ID, Дата создания, Автор)
2. Данные → Защитить диапазон
3. Установите "Ограничить редактирование"
4. Выберите "Только я"
5. Сохраните

Повторите для колонок L, N, O, P, Q, R, S (статусы и результаты оплаты).

### Защита листа "Балансы кошельков":

1. Правой кнопкой на вкладке листа → Защитить лист
2. Выберите "Показать предупреждение"
3. Или установите "Только владелец и указанные пользователи"

### Защита формул в таблице "Зарплаты":

1. Выделите колонку I (ИТОГО к выплате)
2. Защитите диапазон
3. Установите "Только я"

## Шаг 8: Проверка подключения

После настройки `.env` файла запустите систему:

```bash
npm install
npm run dev
```

Если все настроено правильно, вы увидите:
```
✅ Database initialized successfully
✅ Telegram bot started successfully
✅ System started successfully!
```

## Troubleshooting

**Ошибка "The caller does not have permission":**
- Проверьте, что сервисный аккаунт добавлен в доступы к таблице
- Убедитесь, что Google Sheets API включен в проекте

**Ошибка "Spreadsheet not found":**
- Проверьте правильность SPREADSHEET_ID в `.env`
- ID должен быть без лишних символов

**Ошибка "Invalid credentials":**
- Проверьте правильность GOOGLE_PRIVATE_KEY
- Убедитесь, что символы `\n` в ключе не потерялись

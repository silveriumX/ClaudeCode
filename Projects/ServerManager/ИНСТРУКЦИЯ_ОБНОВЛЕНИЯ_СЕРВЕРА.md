# Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð° Ñ‡ÐµÑ€ÐµÐ· PuTTY

## ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ

```bash
ssh root@151.241.154.57
```

---

## Ð¨ÐÐ“ 1: ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²Ð¸Ñ

```bash
systemctl stop command-webhook
```

---

## Ð¨ÐÐ“ 2: Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ

```bash
cp /opt/server-monitor/command_handler.py /opt/server-monitor/command_handler.py.backup
```

---

## Ð¨ÐÐ“ 3: Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» command_handler.py

Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð’Ð¡Ð® ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð½Ð¸Ð¶Ðµ Ð¸ Ð²ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð² PuTTY (Ð¿Ñ€Ð°Ð²Ð¾Ð¹ ÐºÐ½Ð¾Ð¿ÐºÐ¾Ð¹ Ð¼Ñ‹ÑˆÐ¸):

```bash
cat > /opt/server-monitor/command_handler.py << 'ENDOFFILE'
#!/usr/bin/env python3
"""
=============================================================================
COMMAND HANDLER - ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð¾Ñ‚ Google Sheets
=============================================================================
ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ: Flask webhook Ð´Ð»Ñ Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð½Ð° Windows ÑÐµÑ€Ð²ÐµÑ€Ð°Ñ…
Ð’ÐµÑ€ÑÐ¸Ñ: 3.1 (Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ set_proxy)
Ð”Ð°Ñ‚Ð°: 21.01.2026
=============================================================================
"""

from flask import Flask, request, jsonify
import logging
import requests
from datetime import datetime
import time

from winrm_connector import WinRMConnector
from server_checker import ServerChecker
import config

# =============================================================================
# Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ FLASK ÐŸÐ Ð˜Ð›ÐžÐ–Ð•ÐÐ˜Ð¯
# =============================================================================

app = Flask(__name__)

# =============================================================================
# ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ Ð›ÐžÐ“Ð˜Ð ÐžÐ’ÐÐÐ˜Ð¯
# =============================================================================

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# =============================================================================
# Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ ÐœÐžÐ”Ð£Ð›Ð•Ð™
# =============================================================================

connector = WinRMConnector(timeout=config.WINRM_TIMEOUT)
checker = ServerChecker()

# =============================================================================
# Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯: ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ Ñ€ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ð¾Ð² Ð¿Ñ€Ð¾ÐºÑÐ¸
# =============================================================================

def parse_proxy_credentials(proxy_string):
    if not proxy_string or not proxy_string.strip():
        return None

    proxy_string = proxy_string.strip()
    result = {
        'protocol': 'SOCKS5',
        'address': '',
        'port': 0,
        'username': '',
        'password': ''
    }

    try:
        if '://' in proxy_string:
            protocol_part, rest = proxy_string.split('://', 1)
            result['protocol'] = protocol_part.upper()

            if '@' in rest:
                auth_part, host_part = rest.split('@', 1)
                if ':' in auth_part:
                    result['username'], result['password'] = auth_part.split(':', 1)
                else:
                    result['username'] = auth_part

                if ':' in host_part:
                    result['address'], port_str = host_part.rsplit(':', 1)
                    result['port'] = int(port_str)
                else:
                    return None
            else:
                if ':' in rest:
                    result['address'], port_str = rest.rsplit(':', 1)
                    result['port'] = int(port_str)
                else:
                    return None
        else:
            parts = proxy_string.split(':')

            if len(parts) == 2:
                result['address'] = parts[0]
                result['port'] = int(parts[1])
            elif len(parts) == 4:
                result['address'] = parts[0]
                result['port'] = int(parts[1])
                result['username'] = parts[2]
                result['password'] = parts[3]
            else:
                return None

        valid_protocols = ['SOCKS5', 'SOCKS4', 'HTTP', 'HTTPS']
        if result['protocol'] not in valid_protocols:
            result['protocol'] = 'SOCKS5'

        if not (1 <= result['port'] <= 65535):
            return None

        if not result['address']:
            return None

        return result

    except (ValueError, AttributeError) as e:
        logger.error(f"Error parsing proxy credentials: {e}")
        return None

# =============================================================================
# Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯: Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
# =============================================================================

def execute_command(rdp, command, proxy_key=None, proxyma_api_key=None, proxy_credentials=None):
    try:
        parts = rdp.split(':')
        if len(parts) < 3:
            return "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ RDP", {}

        ip = parts[0].strip()
        username = parts[1].strip()
        password = ':'.join(parts[2:]).strip()

        start_time = datetime.now()

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: check
        # =========================================================================
        if command == 'check':
            check_result = checker.check_full_status(ip, username, password)

            if check_result['success']:
                result_text = f"âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ({start_time.strftime('%H:%M:%S')})\n"
                result_text += f"IP: {check_result['currentIp']}\n"
                result_text += f"Ð“Ð¾Ñ€Ð¾Ð´: {check_result['currentCity']}\n"
                result_text += f"Proxifier: {'âœ…' if check_result['statusProxy'] == 'OK' else 'âŒ'}\n"
                result_text += f"AnyDesk: {'âœ…' if check_result['anydesk'] else 'âŒ'}\n"
                result_text += f"RustDesk: {'âœ…' if check_result['rustdesk'] else 'âŒ'}"
                return result_text, check_result
            else:
                result_text = f"âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ ({start_time.strftime('%H:%M:%S')})"
                return result_text, check_result

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: check_proxyma
        # =========================================================================
        elif command == 'check_proxyma':
            if not proxyma_api_key:
                return "âŒ Proxyma API Key Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½ Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ", {}
            if not proxy_key:
                return "âŒ Package Key Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½ Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ", {}

            from proxyma_api import ProxymaAPI
            proxyma = ProxymaAPI(proxyma_api_key)

            info = proxyma.get_package_info(proxy_key)
            if not info:
                return "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ð°", {}

            packages = proxyma.get_packages()
            pkg_name = "Unknown"
            for pkg in packages:
                if pkg['package_key'] == proxy_key:
                    pkg_name = pkg['title']
                    break

            balance = proxyma.get_balance()
            tariff_price = proxyma.get_tariff_price(pkg_name)

            try:
                expire_date = datetime.strptime(info['expired_at'], '%Y-%m-%d')
                days_left = (expire_date - datetime.now()).days
            except:
                days_left = "N/A"

            result_text = f"âœ… Proxyma ({start_time.strftime('%H:%M:%S')})\n"
            result_text += f"ÐŸÐ°ÐºÐµÑ‚: {pkg_name}\n"
            result_text += f"Ð¢Ñ€Ð°Ñ„Ð¸Ðº: {info['traffic']['usage']:.2f} / {info['traffic']['limit']} GB\n"
            result_text += f"ÐžÑÑ‚Ð°Ð»Ð¾ÑÑŒ: {info['traffic']['limit'] - info['traffic']['usage']:.2f} GB\n"
            result_text += f"Ð˜ÑÑ‚ÐµÐºÐ°ÐµÑ‚: {info['expired_at']} ({days_left} Ð´Ð½ÐµÐ¹)\n"
            result_text += f"Ð‘Ð°Ð»Ð°Ð½Ñ: ${balance}\n"
            result_text += f"Ð¦ÐµÐ½Ð° Ñ‚Ð°Ñ€Ð¸Ñ„Ð°: {tariff_price}"

            proxy_data = {
                'proxyName': pkg_name,
                'proxyLimit': info['traffic']['limit'],
                'proxyUsed': round(info['traffic']['usage'], 2),
                'proxyLeft': round(info['traffic']['limit'] - info['traffic']['usage'], 2),
                'proxyExpires': info['expired_at'],
                'proxyCheckTime': datetime.now().strftime('%d.%m.%Y %H:%M:%S'),
                'proxyBalance': balance if balance else 'N/A',
                'proxyPrice': tariff_price if tariff_price else 'N/A'
            }

            return result_text, proxy_data

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: get_timezone
        # =========================================================================
        elif command == 'get_timezone':
            tz_info = checker.get_timezone(ip, username, password)
            if tz_info:
                result_text = f"âœ… Ð¢Ð°Ð¹Ð¼Ð·Ð¾Ð½Ð° ({start_time.strftime('%H:%M:%S')})\n"
                result_text += f"ID: {tz_info['id']}\n"
                result_text += f"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ: {tz_info['displayName']}\n"
                result_text += f"Ð¡Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ: {tz_info['offset']}\n"
                result_text += f"Ð’Ñ€ÐµÐ¼Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ: {tz_info['currentTime']}"
                return result_text, {}
            else:
                return f"âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð°Ð¹Ð¼Ð·Ð¾Ð½Ñƒ ({start_time.strftime('%H:%M:%S')})", {}

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: set_timezone_msk
        # =========================================================================
        elif command == 'set_timezone_msk':
            ps_cmd = '''Set-TimeZone -Id "Russian Standard Time"'''
            connector.execute_command(ip, username, password, ps_cmd)
            time.sleep(2)
            check_result = checker.check_full_status(ip, username, password)
            return f"âœ… Ð¢Ð°Ð¹Ð¼Ð·Ð¾Ð½Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð° Ð½Ð° Moscow (MSK) ({start_time.strftime('%H:%M:%S')})", check_result

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: set_timezone_ekt
        # =========================================================================
        elif command == 'set_timezone_ekt':
            ps_cmd = '''Set-TimeZone -Id "Ekaterinburg Standard Time"'''
            connector.execute_command(ip, username, password, ps_cmd)
            time.sleep(2)
            check_result = checker.check_full_status(ip, username, password)
            return f"âœ… Ð¢Ð°Ð¹Ð¼Ð·Ð¾Ð½Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð° Ð½Ð° Ekaterinburg/Perm (EKT) ({start_time.strftime('%H:%M:%S')})", check_result

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: get_languages
        # =========================================================================
        elif command == 'get_languages':
            langs = checker.get_languages(ip, username, password)
            if langs:
                result_text = f"âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ ÑÐ·Ñ‹ÐºÐ¸ ({start_time.strftime('%H:%M:%S')})\n"
                result_text += '\n'.join([f"- {lang}" for lang in langs if lang.strip()])
                return result_text, {}
            else:
                return f"âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐ·Ñ‹ÐºÐ¾Ð² ({start_time.strftime('%H:%M:%S')})", {}

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: set_lang_russian
        # =========================================================================
        elif command == 'set_lang_russian':
            ps_cmd = '''Set-WinUILanguageOverride -Language ru-RU; Set-Culture -CultureInfo ru-RU'''
            connector.execute_command(ip, username, password, ps_cmd)
            return f"âœ… Ð¯Ð·Ñ‹Ðº Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¸Ð¹ (Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°) ({start_time.strftime('%H:%M:%S')})", {}

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: set_lang_english
        # =========================================================================
        elif command == 'set_lang_english':
            ps_cmd = '''Set-WinUILanguageOverride -Language en-US; Set-Culture -CultureInfo en-US'''
            connector.execute_command(ip, username, password, ps_cmd)
            return f"âœ… Ð¯Ð·Ñ‹Ðº Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½ Ð½Ð° Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ð¹ (Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°) ({start_time.strftime('%H:%M:%S')})", {}

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: start_proxifier
        # =========================================================================
        elif command == 'start_proxifier':
            app_path = checker.find_app_path(ip, username, password, "Proxifier")
            if not app_path:
                app_path = "C:\\Program Files (x86)\\Proxifier\\Proxifier.exe"

            ps_cmd = f'''Start-Process "{app_path}"'''
            connector.execute_command(ip, username, password, ps_cmd)
            time.sleep(5)
            check_result = checker.check_full_status(ip, username, password)
            return f"âœ… Proxifier Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ ({start_time.strftime('%H:%M:%S')})", check_result

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: stop_proxifier
        # =========================================================================
        elif command == 'stop_proxifier':
            ps_cmd = '''Stop-Process -Name Proxifier -Force -EA 0'''
            connector.execute_command(ip, username, password, ps_cmd)
            time.sleep(3)
            check_result = checker.check_full_status(ip, username, password)
            return f"âœ… Proxifier Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ ({start_time.strftime('%H:%M:%S')})", check_result

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: restart_proxifier
        # =========================================================================
        elif command == 'restart_proxifier':
            app_path = checker.find_app_path(ip, username, password, "Proxifier")
            if not app_path:
                app_path = "C:\\Program Files (x86)\\Proxifier\\Proxifier.exe"

            ps_cmd = f'''Stop-Process -Name Proxifier -Force -EA 0; Start-Sleep 3; Start-Process "{app_path}"'''
            connector.execute_command(ip, username, password, ps_cmd)
            time.sleep(6)
            check_result = checker.check_full_status(ip, username, password)
            return f"âœ… Proxifier Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½ ({start_time.strftime('%H:%M:%S')})", check_result

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: set_proxy - Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Ð¿Ñ€Ð¾ÐºÑÐ¸ Ð² Proxifier
        # =========================================================================
        elif command == 'set_proxy':
            if not proxy_credentials:
                return "âŒ Ð ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹ Ð¿Ñ€Ð¾ÐºÑÐ¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ", {}

            parsed = parse_proxy_credentials(proxy_credentials)
            if not parsed:
                return "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ€ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ð¾Ð² Ð¿Ñ€Ð¾ÐºÑÐ¸. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ: IP:PORT Ð¸Ð»Ð¸ IP:PORT:LOGIN:PASSWORD", {}

            protocol = parsed['protocol'].replace('"', '`"')
            address = parsed['address'].replace('"', '`"')
            port = parsed['port']
            proxy_user = parsed.get('username', '').replace('"', '`"')
            proxy_pass = parsed.get('password', '').replace('"', '`"')

            ps_cmd = f'''
$protocol = "{protocol}"
$address = "{address}"
$port = {port}
$proxyUser = "{proxy_user}"
$proxyPass = "{proxy_pass}"

$profilePaths = @(
    "$env:APPDATA\\Proxifier4\\Profiles\\Default.ppx",
    "$env:ProgramData\\Proxifier\\Default.ppx",
    "C:\\Users\\$env:USERNAME\\AppData\\Roaming\\Proxifier4\\Profiles\\Default.ppx"
)

$profilePath = $null
foreach ($path in $profilePaths) {{
    if (Test-Path $path) {{
        $profilePath = $path
        break
    }}
}}

if (-not $profilePath) {{
    Write-Output "ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Proxifier Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
    exit 1
}}

$backupPath = "$profilePath.backup.$(Get-Date -Format 'yyyyMMddHHmmss')"
Copy-Item $profilePath $backupPath -Force

try {{
    [xml]$profile = Get-Content $profilePath -Encoding UTF8

    $proxyList = $profile.ProxifierProfile.ProxyList
    $proxy = $null

    if ($proxyList.Proxy.Count -gt 0) {{
        $proxy = $proxyList.Proxy[0]
    }} else {{
        $proxy = $profile.CreateElement("Proxy")
        $proxy.SetAttribute("id", "100")
        $proxy.SetAttribute("type", $protocol)
        $proxyList.AppendChild($proxy) | Out-Null
    }}

    $proxy.SetAttribute("type", $protocol)

    $addressNode = $proxy.Address
    if (-not $addressNode) {{
        $addressNode = $profile.CreateElement("Address")
        $proxy.AppendChild($addressNode) | Out-Null
    }}
    $addressNode.InnerText = $address

    $portNode = $proxy.Port
    if (-not $portNode) {{
        $portNode = $profile.CreateElement("Port")
        $proxy.AppendChild($portNode) | Out-Null
    }}
    $portNode.InnerText = $port.ToString()

    $optionsNode = $proxy.Options
    if (-not $optionsNode) {{
        $optionsNode = $profile.CreateElement("Options")
        $proxy.AppendChild($optionsNode) | Out-Null
    }}

    if ($proxyUser -and $proxyPass) {{
        $optionsNode.InnerText = "64"

        if ($protocol -eq "SOCKS5") {{
            $oldAuth = $proxy.Auth
            if ($oldAuth) {{
                $proxy.RemoveChild($oldAuth) | Out-Null
            }}

            $authNode = $profile.CreateElement("Auth")
            $authNode.SetAttribute("enabled", "true")

            $usernameNode = $profile.CreateElement("Username")
            $usernameNode.InnerText = $proxyUser
            $authNode.AppendChild($usernameNode) | Out-Null

            $passwordNode = $profile.CreateElement("Password")
            $passwordNode.InnerText = $proxyPass
            $authNode.AppendChild($passwordNode) | Out-Null

            $proxy.AppendChild($authNode) | Out-Null
        }}
    }} else {{
        $optionsNode.InnerText = "48"

        $oldAuth = $proxy.Auth
        if ($oldAuth) {{
            $proxy.RemoveChild($oldAuth) | Out-Null
        }}
    }}

    $utf8NoBom = New-Object System.Text.UTF8Encoding $false
    [System.IO.File]::WriteAllText($profilePath, $profile.OuterXml, $utf8NoBom)

    if ($proxyUser -and $proxyPass) {{
        Write-Output "ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½: $protocol`://$proxyUser`:***@$address`:$port"
    }} else {{
        Write-Output "ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½: $protocol`://$address`:$port"
    }}

    $proxifierPaths = @(
        "C:\\Program Files (x86)\\Proxifier\\Proxifier.exe",
        "C:\\Program Files\\Proxifier\\Proxifier.exe"
    )
    $proxifierExe = $null
    foreach ($path in $proxifierPaths) {{
        if (Test-Path $path) {{
            $proxifierExe = $path
            break
        }}
    }}

    if ($proxifierExe) {{
        Start-Process -FilePath $proxifierExe -ArgumentList "`"$profilePath`"", "silent-load" -Wait -NoNewWindow -ErrorAction SilentlyContinue
        Write-Output "ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ Ð² Proxifier"
    }} else {{
        Write-Output "Proxifier.exe Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
    }}
}} catch {{
    Write-Output "ÐžÑˆÐ¸Ð±ÐºÐ°: $($_.Exception.Message)"
    exit 1
}}
'''

            output = connector.execute_command(ip, username, password, ps_cmd)
            time.sleep(3)
            check_result = checker.check_full_status(ip, username, password)

            if output and ("ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½" in output or "ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½" in output):
                return f"âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð¾ÐºÑÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ ({start_time.strftime('%H:%M:%S')})\n{output}", check_result
            else:
                return f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾ÐºÑÐ¸ ({start_time.strftime('%H:%M:%S')})\n{output if output else 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ'}", check_result

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: start_anydesk
        # =========================================================================
        elif command == 'start_anydesk':
            app_path = checker.find_app_path(ip, username, password, "AnyDesk")
            if not app_path:
                app_path = "C:\\Program Files (x86)\\AnyDesk\\AnyDesk.exe"

            ps_cmd = f'''Start-Process "{app_path}"'''
            connector.execute_command(ip, username, password, ps_cmd)
            time.sleep(3)
            check_result = checker.check_full_status(ip, username, password)
            return f"âœ… AnyDesk Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ ({start_time.strftime('%H:%M:%S')})", check_result

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: create_shortcuts
        # =========================================================================
        elif command == 'create_shortcuts':
            ps_cmd = '''
New-Item -Path "C:\\ServerApps" -ItemType Directory -Force | Out-Null
$results = @()
$ProxifierPaths = @("C:\\Program Files (x86)\\Proxifier\\Proxifier.exe","C:\\Program Files\\Proxifier\\Proxifier.exe","C:\\Proxifier\\Proxifier.exe")
$ProxifierFound = $false
foreach ($path in $ProxifierPaths) {
    if (Test-Path $path) {
        $WshShell = New-Object -ComObject WScript.Shell
        $Shortcut = $WshShell.CreateShortcut("C:\\ServerApps\\Proxifier.lnk")
        $Shortcut.TargetPath = $path
        $Shortcut.Save()
        $results += "Proxifier: $path"
        $ProxifierFound = $true
        break
    }
}
if (-not $ProxifierFound) { $results += "Proxifier Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" }
$AnyDeskPaths = @("C:\\Program Files (x86)\\AnyDesk\\AnyDesk.exe","C:\\Program Files\\AnyDesk\\AnyDesk.exe","C:\\AnyDesk\\AnyDesk.exe")
$AnyDeskFound = $false
foreach ($path in $AnyDeskPaths) {
    if (Test-Path $path) {
        $WshShell = New-Object -ComObject WScript.Shell
        $Shortcut = $WshShell.CreateShortcut("C:\\ServerApps\\AnyDesk.lnk")
        $Shortcut.TargetPath = $path
        $Shortcut.Save()
        $results += "AnyDesk: $path"
        $AnyDeskFound = $true
        break
    }
}
if (-not $AnyDeskFound) { $results += "AnyDesk Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" }
$results -join "`n"
'''
            output = connector.execute_command(ip, username, password, ps_cmd)
            return f"âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÑ€Ð»Ñ‹ÐºÐ¾Ð² Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾ ({start_time.strftime('%H:%M:%S')})\n{output}", {}

        # =========================================================================
        # ÐšÐžÐœÐÐÐ”Ð: reboot
        # =========================================================================
        elif command == 'reboot':
            ps_cmd = '''Restart-Computer -Force'''
            connector.execute_command(ip, username, password, ps_cmd)
            return f"âœ… ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð° ({start_time.strftime('%H:%M:%S')})\nÐ¡ÐµÑ€Ð²ÐµÑ€ Ð±ÑƒÐ´ÐµÑ‚ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ 2-3 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹", {}

        # =========================================================================
        # ÐÐ•Ð˜Ð—Ð’Ð•Ð¡Ð¢ÐÐÐ¯ ÐšÐžÐœÐÐÐ”Ð
        # =========================================================================
        else:
            return f"âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°: {command}", {}

    except Exception as e:
        logger.error(f"Command execution error: {e}")
        return f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ: {str(e)}", {}

# =============================================================================
# ENDPOINT: /execute_command
# =============================================================================

@app.route('/execute_command', methods=['POST'])
def handle_command():
    try:
        data = request.get_json()
        rdp = data.get('rdp')
        command = data.get('command')
        proxy_key = data.get('proxyKey')
        proxyma_api_key = data.get('proxymaApiKey')
        proxy_credentials = data.get('proxyCredentials')

        logger.info(f"Executing '{command}' on {rdp}")

        result_text, server_status = execute_command(rdp, command, proxy_key, proxyma_api_key, proxy_credentials)

        update_data = {
            'rdp': rdp,
            'clearCommand': True,
            'datetime': datetime.now().strftime('%d.%m.%Y %H:%M:%S')
        }

        if command == 'check':
            update_data['checkServerResult'] = result_text
        elif command == 'check_proxyma':
            update_data['checkProxyResult'] = result_text
        else:
            update_data['commandResult'] = result_text

        if server_status:
            update_data.update(server_status)

        requests.post(config.SHEETS_API_URL, json=update_data,
                     headers={'Content-Type': 'application/json'},
                     timeout=config.API_TIMEOUT)

        return jsonify({'success': True, 'result': result_text})

    except Exception as e:
        logger.error(f"Webhook error: {e}")
        return jsonify({'success': False, 'error': str(e)})

# =============================================================================
# ENDPOINT: /health
# =============================================================================

@app.route('/health', methods=['GET'])
def health():
    return jsonify({'status': 'ok'})

# =============================================================================
# Ð—ÐÐŸÐ£Ð¡Ðš ÐŸÐ Ð˜Ð›ÐžÐ–Ð•ÐÐ˜Ð¯
# =============================================================================

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)
ENDOFFILE
```

---

## Ð¨ÐÐ“ 4: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²Ð¸Ñ

```bash
systemctl start command-webhook
```

---

## Ð¨ÐÐ“ 5: ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ

```bash
systemctl status command-webhook
```

Ð•ÑÐ»Ð¸ Ð²ÑÐµ OK, ÑƒÐ²Ð¸Ð´Ð¸Ñ‚Ðµ `Active: active (running)`.

---

## Ð¨ÐÐ“ 6: ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)

```bash
journalctl -u command-webhook -f
```

(Ctrl+C Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð¹Ñ‚Ð¸)

---

## Ð’ÑÐµ Ð¾Ð´Ð½Ð¾Ð¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹ (Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ)

Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¸ Ð²ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð² PuTTY:

```bash
systemctl stop command-webhook && cp /opt/server-monitor/command_handler.py /opt/server-monitor/command_handler.py.backup && echo "Backup created"
```

Ð—Ð°Ñ‚ÐµÐ¼ Ð²ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ `cat > /opt/server-monitor/command_handler.py << 'ENDOFFILE'` Ð¸Ð· Ð¨Ð°Ð³Ð° 3.

ÐŸÐ¾ÑÐ»Ðµ Ñ‡ÐµÐ³Ð¾:

```bash
systemctl start command-webhook && systemctl status command-webhook
```

---

## Google Apps Script

ÐšÐ¾Ð´ Ð´Ð»Ñ Google Apps Script Ð½ÑƒÐ¶Ð½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð² Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¾Ñ€Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð² Google Sheets:
1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ Google Sheets
2. Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ â†’ Apps Script
3. Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð²ÐµÑÑŒ ÐºÐ¾Ð´ Ð² Code.gs Ð½Ð° Ð½Ð¾Ð²Ñ‹Ð¹
4. Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ (Ctrl+S)
5. Ð”ÐµÐ¿Ð»Ð¾Ð¹ â†’ ÐÐ¾Ð²Ñ‹Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ (Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹)

---

## ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹

1. Ð’ Google Sheets Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÐºÐ¾Ð»Ð¾Ð½ÐºÑƒ "ÐŸÑ€Ð¾ÐºÑÐ¸ Ñ€ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹" Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ: `IP:PORT:LOGIN:PASSWORD`
2. Ð’ ÐºÐ¾Ð»Ð¾Ð½ÐºÐµ "ÐšÐ¾Ð¼Ð°Ð½Ð´Ð°" Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ: `set_proxy`
3. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð¼ÐµÐ½ÑŽ "ðŸ”§ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ð²ÐµÑ€Ð°Ð¼Ð¸" â†’ "âš¡ Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹"
4. Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð² ÐºÐ¾Ð»Ð¾Ð½ÐºÐµ "Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹"

"""
–ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã: /start, /help
"""
from telegram import Update
from telegram.ext import ContextTypes, ConversationHandler
from src.utils.auth import require_auth, get_user_info
from src import config


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start - —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –Ω–µ–∑–∞–∫–æ–Ω—á–µ–Ω–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é"""
    user = update.effective_user
    sheets = context.bot_data.get('sheets')

    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª—é–±–æ–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä
    context.user_data.clear()

    if not sheets:
        await update.message.reply_text(
            "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–∏—Å—Ç–µ–º–µ."
        )
        return ConversationHandler.END

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    user_info = sheets.get_user(user.id)

    if not user_info:
        # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        await update.message.reply_text(
            f"üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user.first_name}!\n\n"
            "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.\n"
            "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.\n\n"
            f"–í–∞—à Telegram ID: `{user.id}`\n"
            f"Username: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'}",
            parse_mode='Markdown'
        )
        return

    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
    from handlers.menu import show_main_menu

    welcome_text = (
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –Ω–∏–∂–µ.\n\n"
        "_–ï—Å–ª–∏ –∫–Ω–æ–ø–æ–∫ –Ω–µ –≤–∏–¥–Ω–æ ‚Äî –Ω–∞–∂–º–∏—Ç–µ / –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥._"
    )

    await show_main_menu(update, context, welcome_text)

    return ConversationHandler.END


@require_auth
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /help"""
    user_info = get_user_info(update, context)

    if not user_info:
        await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    help_text = "üìñ *–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º Finance Bot*\n\n"

    if user_info['role'] == config.ROLE_MANAGER:
        help_text += (
            "*–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫:*\n"
            "/new\\_request - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É\n"
            "–ë–æ—Ç –ø—Ä–æ–≤–µ–¥–µ—Ç –≤–∞—Å —á–µ—Ä–µ–∑ –≤—Å–µ —à–∞–≥–∏:\n"
            "1. –ü–æ–ª—É—á–∞—Ç–µ–ª—å (–§–ò–û –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ)\n"
            "2. –°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö\n"
            "3. –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–ö–∞—Ä—Ç–∞, –°–ë–ü, –¢–µ–ª–µ—Ñ–æ–Ω –∏ —Ç.–¥.)\n"
            "4. –†–µ–∫–≤–∏–∑–∏—Ç—ã\n"
            "5. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞\n\n"

            "*–ú–æ–∏ –∑–∞—è–≤–∫–∏:*\n"
            "/my\\_requests - –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞ –≤–∞—à–∏—Ö –∑–∞—è–≤–æ–∫\n\n"

            "–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –æ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤–ª–∞–¥–µ–ª—å—Ü—É –Ω–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ."
        )

    elif user_info['role'] == config.ROLE_OWNER:
        help_text += (
            "*–û–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫:*\n"
            "/pending\\_approvals - –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–æ–∫, –æ–∂–∏–¥–∞—é—â–∏—Ö –æ–¥–æ–±—Ä–µ–Ω–∏—è\n"
            "–ü—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –≤—ã –≤—ã–±–∏—Ä–∞–µ—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –æ–ø–ª–∞—Ç—ã.\n\n"

            "*–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫:*\n"
            "/new\\_request - –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä—É)\n\n"

            "*–ú–æ–∏ –∑–∞—è–≤–∫–∏:*\n"
            "/my\\_requests - –ü—Ä–æ—Å–º–æ—Ç—Ä –≤–∞—à–∏—Ö –∑–∞—è–≤–æ–∫\n\n"

            "–ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é –¥–ª—è –æ–ø–ª–∞—Ç—ã."
        )

    elif user_info['role'] == config.ROLE_EXECUTOR:
        help_text += (
            "*–û–ø–ª–∞—Ç–∞ –∑–∞—è–≤–æ–∫:*\n"
            "/pending\\_payments - –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫\n"
            "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã. –î–ª—è RUB/BYN ‚Äî —Å—Ä–∞–∑—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ; "
            "–¥–ª—è USDT ‚Äî –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å–ø–∏—Å–∞–Ω–Ω—ã—Ö USDT, –∑–∞—Ç–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.\n\n"
            "–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ Google Sheets."
        )

    elif user_info['role'] == config.ROLE_REPORT:
        help_text += (
            "*–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫:*\n"
            "/new\\_request - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É\n\n"
            "*–ú–æ–∏ –∑–∞—è–≤–∫–∏:*\n"
            "/my\\_requests - –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞ –≤–∞—à–∏—Ö –∑–∞—è–≤–æ–∫\n\n"
            "*–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã:*\n"
            "/fact - –í–Ω–µ—Å—Ç–∏ —Ä–∞—Å—Ö–æ–¥ –Ω–∞–ª–∏—á–Ω—ã–º–∏ (RUB)\n"
        )

    help_text += "\n\n_–î–ª—è –ø–æ–º–æ—â–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É_"

    await update.message.reply_text(help_text, parse_mode='Markdown')

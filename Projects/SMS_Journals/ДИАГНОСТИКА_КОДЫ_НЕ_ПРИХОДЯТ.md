# Почему не приходят коды — чек-лист

Скрипт получает SMS двумя способами: **веб-хук** (мгновенно) и **история API / опрос** (раз в N минут). Ниже — что проверить у себя и когда винить оператора.

---

## 1. Со своей стороны (скрипт и настройки)

### Properties (Script Properties)

| Свойство        | Нужно | Проверка |
|-----------------|-------|----------|
| `MSAPI_TOKEN`   | Да    | Полный JWT без пробелов. Тот же токен, что в личном кабинете МТТ. |
| `CUSTOMER_NAME` | Да    | Лицевой счёт, например `110028140`. Обязателен для истории и для фильтра номеров. |
| `WEBHOOK_SECRET`| Да    | Строка для `?key=...` в URL веб-хука. **Должна совпадать** с тем, что подставлено в event_url при «Подключить уведомления». |

- Если в интерфейсе Properties значение обрезано — это нормально, главное чтобы при сохранении был вставлен **целиком** токен.

### Web App (деплой)

- Скрипт должен быть опубликован: **Deploy → Manage deployments → Web app**.
- **Execute as:** Me
- **Who has access:** обязательно **Anyone** (или «Anyone with the link»), иначе серверы МТТ не смогут вызвать URL.

**Если тест POST даёт HTTP 404:**

- 404 значит: по этому URL приложение не отдаёт ответ (деплой не тот, отключён или доступ не «Anyone»).
- Сделайте:
  1. **Deploy → Manage deployments** — проверьте, что деплой с этим URL есть и активен.
  2. **Deploy → New deployment** — Type: **Web app**, **Execute as: Me**, **Who has access: Anyone** → **Deploy**.
  3. Скопируйте **новый** URL из «Web app URL» (он может измениться при новом деплое).
  4. В меню скрипта снова нажмите **«Подключить уведомления на номерах (MTT)»**, чтобы на номерах в МТТ прописался актуальный event_url (с новым URL при необходимости).

### URL веб-хука и event_url

- Ожидаемый URL: `https://script.google.com/.../exec?key=ВАШ_WEBHOOK_SECRET`.
- Этот же URL должен быть прописан в МТТ на каждый номер через **«Подключить уведомления на номерах (MTT)»** (т.е. в API у номера в поле `event_url`).
- В **«Диагностика веб-хука»** сверьте: «Ожидаемый event_url» и «Event URL из листа Номера» — они должны совпадать.

### Проверки в меню скрипта

1. **«Расширенная диагностика API»** — проверяет токен, GetNumbers, GetMessagesHistoryList и CUSTOMER_NAME. Если там ошибки — сначала чиним их.
2. **«Диагностика веб-хука»** — показывает URL и делает тестовый POST. Если тестовый POST возвращает не 200 — проблема с доступом или с ключом.
3. **«Тестовая запись в журнал»** — убедиться, что запись в «Журнал СМС» вообще появляется.

### Включить логирование входящих запросов

- В Script Properties добавьте: `LOG_WEBHOOK_RAW` = `1` (или `true`).
- После этого каждый входящий GET/POST к Web App будет записываться на лист **«Webhook RAW»** (when, method, query.key, contentType, body).
- Если при отправке кода на номер в «Webhook RAW» **ничего не появляется** — запросы от МТТ до вашего скрипта не доходят (см. раздел «Оператор»).

### Автозагрузка по истории (подстраховка)

- **«Включить автозагрузку (каждые 5 мин)»** — скрипт будет раз в 5 минут забирать входящие по API GetMessagesHistoryList. Коды могут появляться с задержкой до 5 минут, но не зависят от веб-хука.

---

## 2. Со стороны оператора (МТТ)

Имеет смысл говорить с оператором, если:

- **«Расширенная диагностика API»** и **«Диагностика веб-хука»** у вас зелёные, тестовый POST отвечает 200.
- В **«Webhook RAW»** при приходе SMS на номер **нет ни одной новой строки** (при включённом LOG_WEBHOOK_RAW).
- На номерах точно вызывали **«Подключить уведомления»** после последнего деплоя (URL мог поменяться при новой версии Web App).

Тогда возможные причины:

- На стороне МТТ на номер не прописан ваш `event_url` или прописан старый URL.
- МТТ не шлёт webhook на входящие SMS (ограничение продукта, сбой, другой формат).
- Firewall/белый список у оператора не разрешает вызовы на `script.google.com`.

---

## 3. Что изменено в скрипте (исправления)

- **Дубли в журнале:** при сборе существующих записей для проверки дублей использовался диапазон до `last-1`, из-за чего последняя строка не учитывалась. Исправлено на `last`, чтобы учитывались все строки журнала.
- **Отладка веб-хука:** при включённом `LOG_WEBHOOK_RAW` теперь логируются и входящие POST (не только GET), так что в «Webhook RAW» видно, доходят ли вызовы от МТТ до скрипта.

После правок скрипт нужно сохранить и при необходимости создать новую версию деплоя Web App (если меняли doPost/doGet).

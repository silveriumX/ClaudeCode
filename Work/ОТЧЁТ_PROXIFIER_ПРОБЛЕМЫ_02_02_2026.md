# Отчёт: Проблемы с изменением Proxifier через SSH и их решение

**Дата:** 02.02.2026
**Сервер:** 62.84.101.97
**Задача:** Изменить прокси в Proxifier (порт с 10000 → 10010) и перезапустить через SSH

---

## Найденные проблемы

### 1. **ProxyList отсутствовал в профиле**

**Проблема:**
При первой попытке изменения в файле Default.ppx не было тега `<ProxyList>`, поиск по regex не находил куда вставлять прокси.

**Решение:**
Добавить проверку: если `<ProxyList>` не найден, вставить перед `</ProxifierProfile>`:

```powershell
if ($content -match '</ProxifierProfile>') {
    $content = $content -replace '</ProxifierProfile>', "$newProxyList`n</ProxifierProfile>"
}
```

**Статус:** ✅ Исправлено

---

### 2. **Proxifier запускается и сразу завершается**

**Проблема:**
При запуске через SSH (с помощью `Start-Process`, `WMI` или `schtasks /RU SYSTEM`) Proxifier создавался в **Session 0** (service session). Процесс появлялся на 1-3 секунды и закрывался, так как Proxifier — GUI-приложение и ему нужна интерактивная сессия пользователя.

**Диагностика:**
- `query user` показал активную RDP-сессию **Session 2** (`rdp-tcp#1`, пользователь administrator)
- `explorer.exe` запущен → GUI активен
- Запуск через локальный PowerShell-скрипт (не по SSH) держал Proxifier живым → проблема в изоляции SSH-сессии

**Решение:**
Запускать Proxifier через Task Scheduler с параметром `InteractiveToken` (не `SYSTEM`):

```xml
<Principal>
  <UserId>administrator</UserId>
  <LogonType>InteractiveToken</LogonType>
  <RunLevel>HighestAvailable</RunLevel>
</Principal>
```

**Команда:**
```powershell
schtasks /Create /TN TaskName /XML task.xml /F
schtasks /Run /TN TaskName
```

**Результат:**
- Proxifier запускается в Session 2 (пользовательская RDP-сессия)
- Процесс стабилен: PID=15440, Memory=41MB, работает более 30 секунд

**Статус:** ✅ Исправлено

---

### 3. **Несколько портов в профиле после изменений**

**Проблема:**
После обновления профиля в нём обнаружено **два порта**: 10004 и 10010.
Regex при чтении показывает первый найденный порт (10004), хотя мы добавили ProxyList с 10010.

**Возможные причины:**
- В профиле Proxifier есть другие теги с портами (например, `<RulesOrProxies>`, старые записи `<Proxy>`).
- Наш код добавлял новый ProxyList, но не удалял старый/дублирующий тег.

**Решение (применено):**
```powershell
# Удалить ВСЕ старые ProxyList перед вставкой нового
$content = $content -replace '<ProxyList>.*?</ProxyList>', ''
$content = $content -replace '<ProxyList\s*/>', ''
# Затем вставить новый
$content = $content -replace '</ProxifierProfile>', "$newProxyList`n</ProxifierProfile>"
```

**Проверка после перезапуска:**
`PROFILE_PORT:10004` всё ещё показывается первым. Это значит:
- либо порт 10004 находится в другом теге (не ProxyList);
- либо Proxifier кеширует настройки и нужна очистка кеша/реестра.

**Статус:** ⚠️ Частично исправлено — профиль обновлён, но порт 10004 остаётся в файле

---

### 4. **Внешний IP не меняется / прокси не работает**

**Проблема:**
После перезапуска Proxifier:
- `curl https://api.ipify.org` возвращает `62.84.101.97` (IP сервера) или таймаут
- Ожидаемо: IP прокси-сервера или другой IP через SOCKS5

**Возможные причины:**
1. **Прокси-реквизиты неверны** (хост, порт, логин/пароль).
2. **Proxifier не применяет ProxyList** (использует старые настройки или Direct Connection).
3. **Rules в Proxifier не настроены** — возможно, в профиле есть правило "Direct" для всех соединений, а прокси игнорируется.
4. **SOCKS5 прокси недоступен** или заблокирован для сервера.

**Проверки:**
- Порт 10010 на `185.162.130.86` — нужно проверить доступность (telnet/Test-NetConnection).
- Содержимое тега `<RuleList>` в Default.ppx — возможно, там указан `<Action type="Direct">`.

**Решение:**
Необходимо:
1. Прочитать полный профиль Default.ppx (вывести содержимое) и проверить:
   - Сколько `<Proxy>` тегов
   - Какие `<Rule>` есть в `<RuleList>`
   - Есть ли `<RulesOrProxies>` или другие теги с портами
2. Если Rules указывают на Direct — изменить Action на использование прокси с id="100".
3. Проверить доступность прокси:
   ```powershell
   Test-NetConnection -ComputerName 185.162.130.86 -Port 10010
   ```

**Статус:** ❌ Не работает — требуется дополнительная диагностика

---

## Что сейчас работает

✅ **SSH подключение** к серверу 62.84.101.97
✅ **Изменение файла Default.ppx** — профиль обновляется, бэкап создаётся
✅ **Запуск Proxifier в пользовательской RDP-сессии** — процесс стабилен (Session 2)
✅ **Proxifier не падает** — работает более 30 секунд после запуска

---

## Что требует исправления

⚠️ **Множественные порты в профиле** — после изменений остаются старые теги с портом 10004
⚠️ **Правила (Rules) в Proxifier** — возможно, не настроены на использование прокси
❌ **Прокси не применяется** — внешний IP не меняется, трафик не идёт через прокси

---

## Рекомендации

### Краткосрочные (для тестирования)

1. **Прочитать полный Default.ppx:**
   ```powershell
   $content = [IO.File]::ReadAllText("$env:APPDATA\Proxifier4\Profiles\Default.ppx")
   Write-Output $content
   ```
   Найти все `<Proxy>`, `<Port>`, `<Rule>` теги.

2. **Проверить доступность прокси:**
   ```powershell
   Test-NetConnection -ComputerName 185.162.130.86 -Port 10010
   ```
   Если недоступен — менять реквизиты прокси на рабочие.

3. **Изменить Rules (если нужно):**
   Если в `<RuleList>` есть правило `<Action type="Direct">`, заменить на:
   ```xml
   <Action type="Proxy">100</Action>
   ```
   где `100` — id прокси из `<ProxyList>`.

4. **Полная очистка и пересоздание профиля:**
   Вместо частичной правки — создать новый Default.ppx с нуля (шаблон с ProxyList и Rules).

### Долгосрочные (автоматизация)

1. **Обновить команду set_proxy в ServerManager:**
   - Добавить очистку всех `<ProxyList>` перед вставкой нового
   - Проверять и корректировать `<RuleList>` (чтобы прокси реально применялся)
   - Использовать Task Scheduler с InteractiveToken для запуска в GUI-сессии

2. **Создать функцию проверки после изменения:**
   - Подождать 5-10 секунд после перезапуска
   - Проверить внешний IP (`curl https://api.ipify.org`)
   - Если IP = IP сервера → ошибка, прокси не работает

3. **Логирование:**
   Сохранять вывод каждой операции (бэкап, изменение, проверка) для отладки.

---

## Файлы и скрипты

- **Тест изменения прокси:** `Scripts/test_change_proxifier.py`
- **Диагностика запуска:** `Scripts/diagnose_proxifier_deep.py`
- **Исправление запуска в сессии:** `Scripts/fix_proxifier_launch_session.py`
- **Перезапуск с новым портом:** `Scripts/restart_proxifier_with_new_port.py`

Все скрипты сохранены в репозитории, используют paramiko для SSH.

---

## Итог

**Удалось:**
Изменить профиль Proxifier и стабильно запустить его в пользовательской RDP-сессии через SSH.

**Не удалось:**
Применить прокси реально — внешний IP остаётся IP сервера, трафик не идёт через SOCKS5.
Причина: либо прокси недоступен (порт 10010), либо Rules в Proxifier указывают на Direct, либо в профиле конфликтуют несколько прокси/портов.

**Следующий шаг:**
Прочитать полное содержимое Default.ppx, проверить доступность прокси на порту 10010 и при необходимости пересоздать профиль с правильными Rules.

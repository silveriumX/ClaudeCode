---
name: tabular-schema-evolution
description: Write rows to a table (Sheets, Airtable, CSV) when schema may change. Keep single source of truth for column headers in code; on mismatch rename old sheet to archive and create new. Use when app appends rows to spreadsheet, adds or renames columns, or user reports wrong column alignment.
---

# Запись в таблицу при смене схемы

## Правила

### 1. Один источник правды для колонок

- В коде хранить **константу со списком заголовков** (например `HEADERS = ["Дата", "Название", "Тип", ...]`). Порядок и имена колонок при записи строк должны совпадать с этим списком. Никакого дублирования списка в разных местах.

### 2. Проверка при первой записи (или при каждом обращении к листу)

- Прочитать первую строку листа (заголовки). Если она **не совпадает** с эталонным списком из кода:
  - Переименовать текущий лист в архив, например `ЛистName_archive_YYYYMMDD_HHMM`.
  - Создать новый лист с тем же именем и записать в первую строку эталонные заголовки.
  - Дальше писать строки данных в новый лист.
- Так при изменении набора колонок в коде старые данные остаются в архиве, а новые строки всегда попадают в правильные колонки.

### 3. Формат строки

- Каждая строка — массив значений в **том же порядке**, что и в списке заголовков. Не пропускать колонки и не менять порядок «для удобства».
